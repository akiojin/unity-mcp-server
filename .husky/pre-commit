# ステージされたファイルを取得
REPO_ROOT=$(git rev-parse --show-toplevel)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "No files staged for commit."
  exit 0
fi

# JavaScriptファイルのチェック（ESLint + Prettier）
JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|mjs|cjs)$' || true)
if [ -n "$JS_FILES" ]; then
  echo "Running ESLint on staged JavaScript files..."
  JS_FILES_ABS=$(echo "$JS_FILES" | xargs -I{} realpath {})
  echo "$JS_FILES_ABS" | xargs npx eslint --fix
  if [ $? -ne 0 ]; then
    echo "ESLint found errors. Please fix them before committing."
    exit 1
  fi

  echo "Running Prettier on staged JavaScript files..."
  echo "$JS_FILES_ABS" | xargs npx prettier --write

  # 修正されたファイルを再度ステージング
  echo "$JS_FILES_ABS" | xargs git add
fi

# Markdownファイルのチェック
MD_FILES=$(echo "$STAGED_FILES" | grep -E '\.md$' || true)
if [ -n "$MD_FILES" ]; then
  echo "Running markdownlint on staged Markdown files..."
  echo "$MD_FILES" | xargs npx markdownlint --fix --config "$REPO_ROOT/.markdownlint.json"
  if [ $? -ne 0 ]; then
    echo "markdownlint found errors. Please fix them before committing."
    exit 1
  fi

  # 修正されたファイルを再度ステージング
  echo "$MD_FILES" | xargs git add
fi

echo "Pre-commit checks passed!"
