#!/bin/sh
set -e

REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT" || exit 1

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
if [ -z "$STAGED_FILES" ]; then
  echo "No files staged for commit."
  exit 0
fi

RUST_FILES=$(echo "$STAGED_FILES" | grep -E '\.rs$' || true)
if [ -n "$RUST_FILES" ]; then
  echo "Running cargo fmt..."
  cargo fmt
  echo "$RUST_FILES" | xargs git add
fi

MD_FILES=$(echo "$STAGED_FILES" | grep -E '\.md$' || true)
if [ -n "$MD_FILES" ]; then
  if ! command -v pnpm >/dev/null 2>&1; then
    echo "pnpm is required for markdownlint."
    exit 1
  fi
  echo "Running markdownlint..."
  echo "$MD_FILES" | xargs pnpm exec markdownlint --fix --config "$REPO_ROOT/.markdownlint.json"
  echo "$MD_FILES" | xargs git add
fi

echo "Pre-commit checks passed."
