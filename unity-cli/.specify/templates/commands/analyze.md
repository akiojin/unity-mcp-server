---
description: tasks生成後に、spec/plan/tasks の整合性と品質を横断分析します（読み取り専用・非破壊）。
scripts:
  sh: .specify/scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: .specify/scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

## ユーザー入力

```text
$ARGUMENTS
```

空でない場合、続行する前にユーザー入力を考慮する**必要があります**。

## 目的

`/speckit.tasks` が完全な `tasks.md` を生成した後、実装前に3つのコアアーティファクト（`spec.md`、`plan.md`、`tasks.md`）間の矛盾、重複、曖昧さ、未指定項目を特定する。

## 重要な制約

- **厳密に読み取り専用**: ファイルを編集しない。構造化された分析レポートのみ出力。修復計画は任意で提示（ユーザーが明示的に承認するまで編集しない）。
- **憲章優先**: プロジェクト憲章（`/memory/constitution.md`）はこの分析スコープ内で**交渉不可**。憲章との矛盾は自動的にCRITICALとなり、仕様・計画・タスクの調整が必要。

## 実行手順

### 1. 分析コンテキスト初期化

`{SCRIPT}` をリポジトリルートから1回実行し、JSONから `FEATURE_DIR` と `AVAILABLE_DOCS` を取得。絶対パスを導出:

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

必須ファイルが欠けている場合はエラーメッセージで中断。

### 2. アーティファクト読み込み（段階的開示）

各アーティファクトから最小限必要なコンテキストのみ読み込む:

**spec.md から**:
- 概要/コンテキスト
- 機能要件
- 非機能要件
- ユーザーストーリー
- エッジケース（あれば）

**plan.md から**:
- アーキテクチャ/スタック選択
- データモデル参照
- フェーズ
- 技術的制約

**tasks.md から**:
- タスクID
- 説明
- フェーズグルーピング
- 並列マーカー [P]
- 参照ファイルパス

**憲章から**:
- `/memory/constitution.md` を原則検証のため読み込み

### 3. 検出パス（トークン効率的分析）

高信号の発見に焦点を当てる。合計50件まで、残りはオーバーフローサマリーに集約。

#### A. 重複検出
- 類似した要件を特定
- 低品質な表現を統合対象としてマーク

#### B. 曖昧さ検出
- 測定可能な基準のない曖昧な形容詞（高速、スケーラブル、セキュア、直感的、堅牢）をフラグ
- 未解決のプレースホルダー（TODO, TKTK, ???, `<placeholder>` 等）をフラグ

#### C. 未指定
- 動詞があるが目的語や測定可能な結果がない要件
- 受け入れ基準の整合性がないユーザーストーリー
- spec/planで定義されていないファイルやコンポーネントを参照するタスク

#### D. 憲章整合
- MUST原則と矛盾する要件や計画要素
- 憲章からの必須セクションや品質ゲートの欠落

#### E. カバレッジギャップ
- 関連タスクがゼロの要件
- 要件/ストーリーにマッピングされないタスク
- タスクに反映されない非機能要件（パフォーマンス、セキュリティ等）

#### F. 不整合
- 用語のドリフト（ファイル間で同じ概念が異なる名前）
- 計画で参照されているがspecにないデータエンティティ（またはその逆）
- タスク順序の矛盾

### 4. 深刻度割り当て

- **CRITICAL**: 憲章のMUST違反、コアspecアーティファクトの欠落、基本機能をブロックするゼロカバレッジ要件
- **HIGH**: 重複/矛盾要件、曖昧なセキュリティ/パフォーマンス属性、テスト不能な受け入れ基準
- **MEDIUM**: 用語ドリフト、非機能タスクカバレッジ欠落、未指定エッジケース
- **LOW**: スタイル/表現改善、実行順序に影響しない軽微な冗長性

### 5. 分析レポート出力

以下の構造でMarkdownレポートを出力（ファイル書き込みなし）:

## 仕様分析レポート

| ID | カテゴリ | 深刻度 | 場所             | 要約           | 推奨                       |
|----|----------|--------|------------------|----------------|----------------------------|
| A1 | 重複     | HIGH   | spec.md:L120-134 | 類似要件2つ... | より明確な版を保持して統合 |

**カバレッジ要約表**:

| 要件キー | タスクあり? | タスクID | 備考 |
|----------|-------------|----------|------|

**憲章整合問題**: （あれば）

**未マッピングタスク**: （あれば）

**メトリクス**:
- 総要件数
- 総タスク数
- カバレッジ率（1つ以上のタスクがある要件）
- 曖昧さ件数
- 重複件数
- CRITICAL問題件数

### 6. 次のアクション提示

レポート末尾に簡潔な次のアクションブロックを出力:

- CRITICAL問題がある場合: `/speckit.implement` 前に解決を推奨
- LOW/MEDIUMのみ: 進行可能だが改善提案を提示
- 明示的なコマンド提案: 例「/speckit.specify で改良」「/speckit.plan でアーキテクチャ調整」「tasks.md を手動編集して'performance-metrics'カバレッジ追加」

### 7. 修復提案

ユーザーに質問: 「上位N件の問題について具体的な修復編集を提案しますか？」（自動適用はしない）
