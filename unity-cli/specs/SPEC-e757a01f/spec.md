# 機能仕様書: C# LSP統合機能

**機能ID**: `SPEC-e757a01f`
**作成日**: 2025-10-17
**更新日**: 2025-11-26
**ステータス**: 進行中
**入力**: ユーザー説明: "C# LSP統合機能"

**統合SPEC**:
- SPEC-aa705b2b: コードインデックスビルドのバックグラウンド実行（実装完了）
- SPEC-eb99c755: Prebuilt better-sqlite3 配布（未実装）

## 実行フロー (main)
```
1. 入力からユーザー説明を解析
   → 完了: "C# LSP統合機能"
2. 説明から主要概念を抽出
   → アクター: Unity開発者、LLMユーザー
   → アクション: シンボル検索、参照検索、構造化編集、軽量スニペット編集、リネーム、インデックス管理
   → データ: C#シンボル、ソースコード、編集操作
   → 制約: Roslyn LSP、Unity非依存、構造化操作のみ
3. 不明確な側面: なし（既存実装のSpec化）
4. ユーザーシナリオ＆テストセクションを記入
   → 7つの主要ユーザーストーリー定義済み
5. 機能要件を生成
   → 34個の機能要件をテスト可能な形式で定義
6. 主要エンティティを識別
   → シンボル、編集操作、インデックス
7. レビューチェックリストを実行
   → 技術詳細は参考実装セクションに分離
   → 要件はテスト可能
8. 戻り値: SUCCESS (計画準備完了)
```

---

## ⚡ クイックガイドライン
- ✅ ユーザーが「何を」必要とし「なぜ」必要なのかに焦点を当てる
- ❌ 「どのように」実装するかを避ける (技術スタック、API、コード構造なし)
- 👥 ビジネス関係者向けに記述 (開発者向けではない)

---

## 機能概要

自己完結型のC# Language Server (LSP) を使用した、シンボル検索・参照検索・構造化編集・軽量スニペット編集・リネーム・インデックス管理機能。Unity通信に依存せず、ローカルでC#コードを安全に操作する。

### ビジネス価値

- **安全なコード編集**: 構造化操作により、行ベースの危険な編集を排除
- **効率的な検索**: シンボルインデックスにより、大規模コードベースでも高速検索
- **Unity非依存**: LSPはスタンドアロンで動作し、Unity Editor停止中でもコード編集可能
- **柔軟な編集粒度**: 大規模な構造化編集と1-2行の軽量編集を使い分けることで、LLMエージェントの効率を最大化

---

## ユーザーシナリオ＆テスト

### 主要ユーザーストーリー

#### US-1: シンボル検索

**AS** Unity開発者
**I WANT** クラス名/メソッド名/フィールド名でシンボルを検索したい
**SO THAT** 大規模プロジェクトでも目的のコードを素早く特定できる

**受け入れ基準**:
- 名前でシンボルを検索できる（部分一致/完全一致）
- シンボル種別（class/method/field/property）で絞り込める
- 検索スコープ（Assets/Packages/All）を指定できる
- 検索結果にファイルパス、行番号、コンテナ情報が含まれる

#### US-2: 参照検索

**AS** Unity開発者
**I WANT** シンボルの使用箇所をすべて検索したい
**SO THAT** リファクタリング影響範囲を把握できる

**受け入れ基準**:
- シンボル名を指定して参照箇所を検索できる
- 参照箇所にファイルパス、行番号、コード断片が含まれる
- スニペットコンテキスト行数を指定できる
- ページング対応でLLM最適化されている

#### US-3: 構造化編集（挿入/置換）

**AS** Unity開発者
**I WANT** メソッド本体やクラスメンバーを安全に編集したい
**SO THAT** 手動の行番号指定による編集ミスを防げる

**受け入れ基準**:
- シンボルを指定してメソッド本体を置換できる
- クラス内にメソッドを挿入できる（before/after指定）
- 編集前にプレビューできる（オプション）
- エラー時に詳細な診断情報が返る

#### US-4: リネーム（リファクタリング）

**AS** Unity開発者
**I WANT** クラス/メソッド/フィールド名を一括リネームしたい
**SO THAT** 手動での置換漏れを防げる

**受け入れ基準**:
- シンボルを指定してプロジェクト全体でリネームできる
- リネーム前にプレビューできる
- 依存ファイルすべてに変更が適用される

#### US-5: シンボル定義取得

**AS** LLMユーザー
**I WANT** ファイル内のすべてのシンボル定義を取得したい
**SO THAT** コード構造を理解できる

**受け入れ基準**:
- ファイルパスを指定してシンボル一覧を取得できる
- シンボルの種別、名前、位置、コンテナが含まれる
- ネストされたシンボル（内部クラス等）も取得できる

#### US-6: コードインデックス管理

**AS** Unity開発者
**I WANT** コードインデックスを構築・更新したい
**SO THAT** シンボル検索が高速に動作する

**受け入れ基準**:
- プロジェクト全体のインデックスを構築できる
- インデックス状態（ファイル数、カバレッジ）を確認できる
- 増分更新をサポートする

#### US-7: 軽量スニペット編集

**AS** LLMエージェント
**I WANT** 1-2行規模のコード断片を安全に編集したい
**SO THAT** メソッド全体を置換せずに局所的な変更を高速に適用できる

**受け入れ基準**:
- 同一ファイル内で最大10箇所の編集を1回の呼び出しで処理できる
- アンカー文字列（前後のコードスニペット）を指定して編集対象を特定できる
- 編集内容は80文字以内に制限され、超過する場合は拒否される
- 括弧・波括弧の整合性チェックが自動実行され、エラー時はロールバックされる
- 各編集の適用結果（applied/skipped/error）と理由が返される
- ガード削除（nullチェック等）、条件式の最小変更、ログ挿入が主な用途

**主要サブシナリオ**:

**US-7.1: ガード削除**
- 例外的なnullチェック（`if (foo == null) { return; }`）を安全に削除
- 削除対象が見つからない場合は適用せず、警告を返す
- 編集後の空行や余分なセミコロンを自動整理

**US-7.2: 条件式の最小変更**
- 比較演算子や呼び出し名など部分一致で最大5箇所まで置換
- 周辺コンテキスト（前後2行）を指定して誤適用を防ぐ

**US-7.3: ログ挿入**
- return文など特定キーワードをアンカーに直前へ1行挿入
- 既存ログとの重複を検出し、重複時は挿入しない

#### US-8: バックグラウンドインデックスビルド（実装完了）

**AS** Unity開発者
**I WANT** コードインデックスのビルドをバックグラウンドで実行したい
**SO THAT** ビルド完了を待たずに他の作業を継続できる

**受け入れ基準**:
- インデックスビルド開始後、1秒以内にジョブIDとともにレスポンスが返る
- 実行中のビルドの進捗状況（処理済み/全体、処理速度）を確認できる
- 既にビルドが実行中の場合、新たなビルドは開始されず既存のジョブIDが返される
- ビルド完了時に結果情報（更新ファイル数、削除ファイル数、総シンボル数）を取得できる
- 自動ビルド（IndexWatcher）と手動ビルドが同時に実行されることがない

**主要サブシナリオ**:

**US-8.1: 非ブロッキングなビルド開始**
- 大規模プロジェクト（10000+ファイル）でもビルド開始が1秒以内に完了
- ビルド開始後も他のMCPツールは正常に動作

**US-8.2: 進捗確認**
- get_index_statusでリアルタイムの進捗情報を取得
- 処理速度（files/sec）から完了時間を予測可能

**US-8.3: 重複実行防止**
- 手動ビルド実行中に自動ビルドがトリガーされてもスキップ
- 手動ビルド完了後に自動ビルドが再開

#### US-10: Worker Threadsによる非ブロッキングビルド（未実装）

**AS** Unity開発者
**I WANT** バックグラウンドインデックスビルド中も他のMCPツールが即座に応答してほしい
**SO THAT** ビルド中でもシンボル検索やpingが遅延なく動作する

**受け入れ基準**:
- バックグラウンドビルド実行中も`ping`が1秒以内に応答する
- バックグラウンドビルド実行中も`get_index_status`が即座に進捗を返す
- バックグラウンドビルド実行中も`search`、`find_symbol`が正常に動作する
- ビルド処理自体の速度低下は10%以内に抑えられる
- Worker Thread内でエラーが発生してもMCPサーバーは継続動作する

**主要サブシナリオ**:

**US-10.1: 非ブロッキング応答**
- better-sqlite3の同期DB操作がメインスレッドをブロックしない
- LSP documentSymbol呼び出しがメインスレッドをブロックしない

**US-10.2: Worker Thread管理**
- Worker Threadは必要時にのみ起動し、アイドル時はリソースを解放
- Worker Threadがクラッシュした場合、適切にリカバリーする

**US-10.3: 進捗通知**
- ビルド進捗はメインスレッドに非同期で通知される
- JobManager経由の進捗追跡は維持される

#### US-9: 初回起動の高速化（未実装）

**AS** Unity MCP Server新規ユーザー
**I WANT** 初回起動時にビルド待ち時間なくサーバーを使用したい
**SO THAT** MCPクライアントのタイムアウトを回避できる

**受け入れ基準**:
- `npx @akiojin/unity-cli@latest --help` が30秒以内に完了する
- better-sqlite3のネイティブドライバが初回から利用可能
- 対応外プラットフォームではWASMフォールバックで動作する
- 環境変数でネイティブビルド強制/スキップを制御できる

**主要サブシナリオ**:

**US-9.1: Prebuiltバイナリの自動展開**
- linux/darwin/win32 × x64/arm64のprebuiltバイナリをnpm packageに同梱
- postinstallで適切なバイナリを自動選択・展開

**US-9.2: WASMフォールバック**
- 対応外プラットフォームでは即座にsql.jsにフォールバック
- get_index_statusが成功することを確認

**US-9.3: 環境変数による制御**
- `UNITY_MCP_SKIP_NATIVE_BUILD=1` でネイティブビルドをスキップ
- `UNITY_MCP_FORCE_NATIVE=1` でソースビルドを強制

### 受け入れシナリオ

1. **前提** プロジェクトにC#ファイルが存在、**実行** クラス名検索、**結果** 該当クラスの定義場所が返る
2. **前提** メソッドが複数箇所で使用、**実行** 参照検索、**結果** すべての使用箇所リストが返る
3. **前提** メソッドが存在、**実行** メソッド本体置換、**結果** 新しい本体に置き換わる
4. **前提** クラス名が複数ファイルで使用、**実行** リネーム、**結果** すべてのファイルで名前が変更される
5. **前提** C#ファイルが存在、**実行** シンボル定義取得、**結果** ファイル内の全シンボルリストが返る
6. **前提** プロジェクトが存在、**実行** インデックス構築、**結果** インデックスが作成され、検索が高速化される
7. **前提** メソッド内にnullチェックガードが存在、**実行** アンカー指定でガード削除、**結果** ガードが削除され括弧整合性が保たれる
8. **前提** 条件式に誤った演算子が存在、**実行** 周辺コンテキスト指定で置換、**結果** 正しい演算子に置き換わる
9. **前提** メソッド内に複数のreturn文が存在、**実行** ログ挿入をreturn前に適用、**結果** すべてのreturn直前にログが挿入される
10. **前提** 大規模プロジェクト（10000+ファイル）、**実行** build_index、**結果** 1秒以内にジョブIDが返り、バックグラウンドでビルド継続
11. **前提** インデックスビルドが実行中、**実行** get_index_status、**結果** 進捗情報（処理済み/全体、処理速度）が返る
12. **前提** インデックスビルドが実行中、**実行** 再度build_index、**結果** エラーと既存のジョブIDが返る
13. **前提** npmキャッシュをクリアした状態、**実行** `npx @akiojin/unity-cli@latest --help`、**結果** 30秒以内に完了
14. **前提** 対応外プラットフォーム、**実行** get_index_status、**結果** WASMフォールバックで成功
15. **前提** indexWatcherがバックグラウンドビルドを実行中、**実行** ping、**結果** 1秒以内に応答が返る
16. **前提** indexWatcherがバックグラウンドビルドを実行中、**実行** get_index_status、**結果** 即座に進捗情報が返る
17. **前提** indexWatcherがバックグラウンドビルドを実行中、**実行** search、**結果** 検索結果が正常に返る
18. **前提** Worker Thread内でエラーが発生、**実行** 他のMCPツール呼び出し、**結果** MCPサーバーは継続動作し応答が返る

### エッジケース

- 存在しないシンボルを検索した場合、空の結果が返るか?
- 構造化編集でシンボルが見つからない場合、エラーメッセージは明確か?
- リネーム時に構文エラーが発生した場合、変更はロールバックされるか?
- 大規模プロジェクト（10000+ファイル）でインデックス構築時間は許容範囲か?
- インデックス構築中に検索を実行した場合、どのように処理されるか?
- 軽量スニペット編集でアンカーが一意に決定できない場合、候補一覧が返されるか?
- 編集対象がコメントアウトされている場合、無視して警告が返されるか?
- 編集後にコードフォーマッタが破綻する恐れがある場合、適用が拒否されるか?
- 80文字制限を超える編集指示が与えられた場合、拒否理由と代替案が提示されるか?
- ファイルがロックされている場合、失敗理由が明示されるか?

---

## 要件

### シンボル検索機能要件

- **FR-001**: システムは名前でシンボルを検索できる必要がある（部分一致/完全一致）
- **FR-002**: システムはシンボル種別（class/method/field/property）で絞り込める必要がある
- **FR-003**: システムは検索スコープ（Assets/Packages/Embedded/All）を指定できる必要がある
- **FR-004**: システムは検索結果にファイルパス、行番号、コンテナ情報を含める必要がある

### 参照検索機能要件

- **FR-005**: システムはシンボル名を指定して参照箇所を検索できる必要がある
- **FR-006**: システムは参照箇所にファイルパス、行番号、コード断片を含める必要がある
- **FR-007**: システムはスニペットコンテキスト行数を指定できる必要がある
- **FR-008**: システムは参照検索結果をページングできる必要がある

### 構造化編集機能要件

- **FR-009**: システムはシンボルを指定してメソッド本体を置換できる必要がある
- **FR-010**: システムはクラス内にメソッドを挿入できる必要がある（before/after指定）
- **FR-011**: システムは編集前にプレビューを提供できる必要がある（オプション）
- **FR-012**: システムは編集エラー時に詳細な診断情報を返す必要がある
- **FR-013**: システムは行ベース編集を禁止し、構造化操作のみ許可する必要がある

### リネーム機能要件

- **FR-014**: システムはシンボルを指定してプロジェクト全体でリネームできる必要がある
- **FR-015**: システムはリネーム前にプレビューを提供できる必要がある
- **FR-016**: システムは依存ファイルすべてに変更を適用する必要がある
- **FR-017**: システムはリネーム失敗時に変更をロールバックする必要がある

### シンボル定義取得機能要件

- **FR-018**: システムはファイルパスを指定してシンボル一覧を取得できる必要がある
- **FR-019**: システムはシンボルの種別、名前、位置、コンテナを含める必要がある
- **FR-020**: システムはネストされたシンボル（内部クラス等）も取得できる必要がある

### インデックス管理機能要件

- **FR-021**: システムはプロジェクト全体のインデックスを構築できる必要がある
- **FR-022**: システムはインデックス状態（ファイル数、カバレッジ）を確認できる必要がある
- **FR-023**: システムは増分更新をサポートする必要がある
- **FR-024**: システムはインデックスをSQLiteに永続化する必要がある

### DBインデックス必須要件

- **FR-051**: シンボル検索（find_symbol）はDBインデックスが構築されている場合のみ結果を返し、未構築の場合はLSPフォールバックせずエラーを返す必要がある
- **FR-052**: 参照検索（find_refs）はDBインデックスが構築されている場合のみ実行され、未構築の場合はエラーを返す必要がある
- **FR-053**: インデックスが構築中の場合、システムは`index_building`エラーとビルド進捗情報（処理済み/全体、パーセンテージ）を返す必要がある
- **FR-054**: インデックスが未構築で構築ジョブも実行されていない場合、システムは`index_not_ready`エラーと`build_index`の使用を促すヒントを返す必要がある
- **FR-055**: MCPサーバー起動時にDBインデックスが存在しない場合、システムは自動的にバックグラウンドでインデックス構築を開始する必要がある
- **FR-062**: 参照検索（find_refs）はページングのために `startAfter` を受け付け、結果が切り詰められた場合は `cursor` を返す必要がある

### 軽量スニペット編集機能要件

- **FR-025**: システムは1回の呼び出しで最大10箇所の局所編集を処理できる必要がある
- **FR-026**: システムは各編集指示に操作タイプ（削除/置換/挿入）、アンカー情報、編集内容を必須として受け取る必要がある
- **FR-027**: システムはアンカー検証を行い、対象が一意に決定できない場合は候補一覧を返す必要がある
- **FR-028**: システムはアンカー一致後の差分が80文字以内であることを検証し、超過する場合は拒否する必要がある
- **FR-029**: システムは編集結果適用前に括弧・波括弧の整合性をチェックし、不整合時は全体をロールバックする必要がある
- **FR-030**: システムは各編集について status（applied/skipped/error）と reason、編集前後のスニペットを返す必要がある
- **FR-031**: システムはプレビューモード時に副作用を発生させず、候補結果とフォーマット変更を提示する必要がある
- **FR-032**: システムは Assets/ または Packages/ 外のファイルを拒否する必要がある
- **FR-033**: システムは編集後に空になったブロック（空のif文等）を検出し、警告を返す必要がある
- **FR-034**: システムは編集結果のハッシュを返して edit_structured との併用時の重複適用を防ぐ必要がある
- **FR-035**: システムは C# LSP バイナリを `~/.unity/tools/lsp/<rid>/`（または `UNITY_MCP_TOOLS_ROOT` で指定されたディレクトリ）に配置し、プロジェクトローカルの `./.unity/tools` に依存しない構成を保証する必要がある

### バックグラウンドビルド機能要件（実装完了）

- **FR-036**: システムはインデックスビルドをバックグラウンドで実行し、即座に制御を開発者に返す必要がある
- **FR-037**: システムはビルド開始時に一意のジョブIDを生成して返す必要がある
- **FR-038**: 開発者はいつでもビルドの進捗状況を確認できる必要がある
- **FR-039**: システムは既に実行中のビルドがある場合、新たなビルドを開始せず、既存のジョブIDを返す必要がある
- **FR-040**: システムは実行中のビルドの進捗情報（処理済みファイル数、全体のファイル数、処理速度）を提供する必要がある
- **FR-041**: システムはビルド完了時に結果情報（更新されたファイル数、削除されたファイル数、総シンボル数）を保持する必要がある
- **FR-042**: システムはビルド中のエラーを記録し、開発者に通知する必要がある
- **FR-043**: システムは自動ビルド（IndexWatcher）と手動ビルドの競合を防ぐ必要がある
- **FR-044**: システムは既存のインデックス状態確認機能との下位互換性を維持する必要がある
- **FR-045**: システムは進捗ログを一定パーセンテージごと（デフォルト: 10%）に出力する必要がある

### Worker Threads非ブロッキング機能要件（未実装）

- **FR-056**: システムはインデックスビルド処理をWorker Threadで実行し、メインスレッドをブロックしない必要がある
- **FR-057**: システムはバックグラウンドビルド中も`ping`が1秒以内に応答する必要がある
- **FR-058**: システムはWorker Thread内でのエラーをメインスレッドに伝播し、MCPサーバーの継続動作を保証する必要がある
- **FR-059**: システムはビルド進捗をWorker Threadからメインスレッドに非同期で通知する必要がある
- **FR-060**: システムは既存のbuild_indexツールインターフェースを維持し、後方互換性を保つ必要がある
- **FR-061**: システムはindexWatcherからの呼び出しもWorker Thread経由で実行する必要がある

### Prebuilt配布機能要件（未実装）

- **FR-046**: システムはnpm パッケージに linux/darwin/win32 × x64/arm64 × Node18/20/22 向け better-sqlite3 バイナリを同梱する必要がある
- **FR-047**: システムはインストール時に同梱バイナリを優先して展開し、30秒以内に完了する必要がある
- **FR-048**: システムは未対応プラットフォームでは即座に WASM フォールバックに切り替わる必要がある
- **FR-049**: システムは環境変数でネイティブビルド強制 (`UNITY_MCP_FORCE_NATIVE=1`) またはスキップ (`UNITY_MCP_SKIP_NATIVE_BUILD=1`) を制御できる必要がある
- **FR-050**: システムはREADME（英/日）に初回体験と環境変数の説明を記載する必要がある

### 非機能要件

#### 性能要件

- **NFR-001**: シンボル検索は1000ファイルで1秒以内に完了する必要がある
- **NFR-002**: インデックス構築は10000ファイルで2分以内に完了する必要がある

#### 信頼性要件

- **NFR-003**: 構造化編集は構文エラーを事前検出する必要がある
- **NFR-004**: リネームは原子的操作である必要がある（全成功または全失敗）

#### LLM最適化要件

- **NFR-005**: 検索結果はページング対応である必要がある（maxBytes、pageSize）
- **NFR-006**: 参照検索はスニペットコンテキストを制限できる必要がある
- **NFR-007**: エラーメッセージは要約される必要がある（≤30件、≤200文字）

#### 軽量スニペット編集要件

- **NFR-008**: 最大10箇所編集でレスポンス時間は2秒以内である必要がある（LSP常駐時）
- **NFR-009**: エラーメッセージは200文字以内、日本語で返却される必要がある
- **NFR-010**: 成功応答のテキストフィールドは1000文字以内に抑制される必要がある
- **NFR-011**: 競合発生時は編集箇所を自動スキップし、他の編集は継続する必要がある（ベストエフォート）
- **NFR-012**: LSP未起動時は自動起動を試み、失敗時に詳細なトラブルシュート情報を返す必要がある

#### LSP分離要件

- **NFR-023**: LSP操作は用途別に独立プロセスで実行し、長時間処理が他のLSP操作をブロックしないこと
- **NFR-024**: C# LSPは同一プロセス内でリクエストを並列実行でき、同一ファイルの読み書きは排他制御されること
- **NFR-025**: 実行中のLSPが旧バージョンで、ローカルに新バージョンが存在する場合は再起動して最新バージョンに切り替えること
- **NFR-026**: 複数MCPサーバー起動時はクライアントが対象プロジェクトを指定でき、サーバー側で一致検証を行うこと

#### バックグラウンドビルド要件（実装完了）

- **NFR-013**: ビルド開始後1秒以内にジョブIDとともにレスポンスが返る必要がある
- **NFR-014**: 進捗更新は500ms間隔で行われる必要がある
- **NFR-015**: 完了ジョブは5分後に自動削除される必要がある（メモリリーク防止）

#### Worker Threads要件（未実装）

- **NFR-019**: バックグラウンドビルド中も`ping`が1秒以内に応答する必要がある
- **NFR-020**: Worker Thread化によるビルド処理の速度低下は10%以内に抑える必要がある
- **NFR-021**: Worker Threadによるメモリ使用量の増加は50MB以内に抑える必要がある
- **NFR-022**: Node.js 18以上をサポートする必要がある

#### Prebuilt配布要件（未実装）

- **NFR-016**: `npx @akiojin/unity-cli@latest --help` が30秒以内に完了する必要がある
- **NFR-017**: postinstallスクリプトは5秒以内に完了する必要がある
- **NFR-018**: npm パッケージサイズは50MB未満である必要がある

### 主要エンティティ

- **シンボル**: クラス/メソッド/フィールド/プロパティ等のコード要素。名前、種別、位置、コンテナを持つ
- **編集操作**: コード変更の単位。挿入/置換/削除、対象シンボル、新しいテキストを含む
- **スニペット編集操作**: 軽量な局所編集の単位。操作タイプ（削除/置換/挿入）、アンカー情報（前後のコードスニペット）、編集内容（80文字以内）、適用結果（status/reason）を含む
- **インデックス**: シンボル情報のSQLiteデータベース。高速検索のために永続化される
- **ビルドジョブ**: バックグラウンド実行中または完了したインデックスビルド。ジョブID、状態、進捗情報、結果を持つ
- **Prebuiltバイナリ**: プラットフォーム別のbetter-sqlite3ネイティブバイナリ。OS、CPU、Nodeバージョンの組み合わせで管理

---

## スコープ外

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応:

- コード補完機能
- ホバー情報表示
- 定義ジャンプ（IDEナビゲーション）
- コードフォーマット機能
- リアルタイム診断（エラーチェック）
- 大規模リファクタリング（複数ファイル横断での意味解析）
- テンプレート生成

---

## 技術制約

- 自己完結型Roslyn LSPを使用（Unity通信不要）
- インデックスは`.unity/cache/code-index`に保存
- 構造化操作とアンカーベース軽量編集をサポート（純粋な行ベース編集禁止）
- Unityコンパイル/ドメインリロードの影響を受けない
- 軽量スニペット編集は80文字制限、最大10箇所/リクエスト

---

## 参考実装

本仕様は既存実装を文書化したものです。参考実装:

- `unity-cli/src/handlers/script/ScriptSymbolFindToolHandler.js`: シンボル検索
- `unity-cli/src/handlers/script/ScriptRefsFindToolHandler.js`: 参照検索
- `unity-cli/src/handlers/script/ScriptEditStructuredToolHandler.js`: 構造化編集
- `unity-cli/src/handlers/script/ScriptEditSnippetToolHandler.js`: 軽量スニペット編集（計画中）
- `unity-cli/src/handlers/script/ScriptRefactorRenameToolHandler.js`: リネーム
- `unity-cli/src/handlers/script/ScriptSymbolsGetToolHandler.js`: シンボル定義取得
- `unity-cli/src/handlers/script/CodeIndexBuildToolHandler.js`: インデックス構築
- `unity-cli/src/handlers/script/CodeIndexStatusToolHandler.js`: インデックス状態

---

## レビュー＆受け入れチェックリスト

### コンテンツ品質
- [x] 実装詳細なし (言語、フレームワーク、API)
- [x] ユーザー価値とビジネスニーズに焦点
- [x] 非技術関係者向けに記述
- [x] すべての必須セクション完成

### 要件完全性
- [x] [要明確化]マーカーが残っていない
- [x] 要件はテスト可能で曖昧さがない
- [x] 成功基準は測定可能
- [x] スコープが明確に境界付けられている
- [x] 依存関係と前提条件が識別されている

---

## 実行ステータス

- [x] ユーザー説明を解析済み
- [x] 主要概念を抽出済み
- [x] 曖昧さをマーク済み（なし）
- [x] ユーザーシナリオを定義済み（US-1〜US-9）
- [x] 要件を生成済み（FR-001〜FR-050、NFR-001〜NFR-018）
- [x] エンティティを識別済み
- [x] レビューチェックリスト合格

**ステータス**: 進行中

**実装状況**:
- [x] US-1〜US-7: C# LSP統合機能（完了）
- [x] US-8: バックグラウンドインデックスビルド（完了）
- [ ] US-9: 初回起動の高速化（未実装）
- [ ] US-10: Worker Threadsによる非ブロッキングビルド（未実装）
