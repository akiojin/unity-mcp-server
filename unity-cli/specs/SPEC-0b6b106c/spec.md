# 機能仕様書: SerializeField 値更新ツール

**機能ID**: `SPEC-0b6b106c`
**作成日**: 2025-11-07
**ステータス**: 下書き
**入力**: ユーザー説明: "Scene/prefab SerializeField update tooling"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - シーン内SerializeFieldを正確に更新したい (優先度: P1)

レベルデザイナーがMCPクライアントからシーン内のGameObjectを指定し、非公開のSerializeField値を正確に変更したい。値変更はUndoや再実行ができ、ヒエラルキーの位置を壊さずに安全に適用される必要がある。

**この優先度の理由**: LLMオペレーションの主目的がシーン調整であり、人手介入を省略できると制作時間を大幅に削減できるため。

**独立テスト**: 任意のシーンGameObjectに対して単一フィールド更新を指示し、レスポンスが旧値と新値を返しつつ、実際のUnityシーンで値が置き換わることを確認すれば完了。

**受け入れシナリオ**:

1. **前提** シーンにSerializeFieldを持つコンポーネントがある、**実行** GameObjectパス・コンポーネント種別・フィールド名と値を指定して更新を要求、**結果** Unity上の値が即時に更新されレスポンスが成功・旧値・新値・保存要否を含む。
2. **前提** Play Mode中で構造変更が禁止されている、**実行** runtime意図がないまま変更を要求、**結果** レスポンスが「Play中はruntime指定必須」の明確なエラーを返す。

---

### ユーザーストーリー2 - Prefab資産をバッチ調整したい (優先度: P2)

テクニカルアーティストがPrefab資産を複数まとめて調整する際、Unityを手動で開かずにMCPからSerializeField値を変更したい。変更後はPrefab保存状態が明示され、必要に応じて差分をプレビューしたい。

**この優先度の理由**: Prefab調整は繰り返し作業であり、遠隔更新により作業時間とエラーを削減できるため。

**独立テスト**: 任意のPrefab資産に対して更新コマンドを発行し、レスポンスに保存状況と必要な後処理（保存済/保存待ち）が含まれるかを検証する。

**受け入れシナリオ**:

1. **前提** 保存済Prefabが存在する、**実行** Prefabパスと内部オブジェクト指定で値更新を要求、**結果** レスポンスが旧値・新値・Prefab保存可否・必要なフォローアップを返す。

---

### ユーザーストーリー3 - 変更前検証だけを実行したい (優先度: P3)

QAオペレーターが安全性のために「適用せず検証のみ」を実行し、ターゲット解決が正しいかを確かめたい。dry-run結果により、影響範囲が安全であると判断できる。

**この優先度の理由**: 誤更新によるPrefab破損を避けられ、規模の大きいチームで承認フローを組みやすいため。

**独立テスト**: dry-runフラグを立ててコマンドを実行し、Unity上の値が変わらずレスポンスだけにプレビュー値が含まれることを確認する。

**受け入れシナリオ**:

1. **前提** ターゲットが存在する、**実行** dry-run付きで更新を要求、**結果** レスポンスに「dryRun: true」「previewValue」が含まれ、Unity上の値はそのまま。

---

### エッジケース

- GameObjectパスやPrefab内部パスが存在しない場合は、人が即座に判断できるエラー文を返し、候補やデバッグ情報を含める。
- Play Mode中に許可されない操作を指示した場合、Play Mode用パラメータの要否を示す警告で止める。
- enum・配列・構造体など複合フィールドに対して誤ったインデックスや値を渡した場合、破壊的変更を行わず詳細な検証メッセージを返す。
- 参照対象のPrefabが編集中／ロック中の場合、競合状態を知らせ、ユーザーが作業モードを切り替えられるようにする。

## 要件 *(必須)*

### 機能要件

- **FR-001**: ユーザーはシーンGameObjectまたはPrefab資産をパス指定し、SerializeField値を単発で更新できる。
- **FR-002**: 操作結果は旧値・新値・対象パス・追加アクション（保存/適用/再確認）を含む要約を返す。
- **FR-003**: dry-run指定時はUnityオブジェクトを変更せず、ターゲット解析結果とプレビュー値を返す。
- **FR-004**: Play Mode中のガード（runtime指定・構造変更制限など）を自動適用し、違反時は安全にブロックする。
- **FR-005**: Prefab資産を編集した際は保存/未保存状態を示し、必要なら保存を自動実行またはユーザーに指示する。
- **FR-006**: 参照型や列挙型に対し、存在しないエントリを指定した場合は明確な理由を付けて失敗させる。
- **FR-007**: すべての操作が履歴に残り、いつ誰がどのフィールドを変更したかを追跡できる。
  - [要明確化] ログの保持期間と閲覧権限は別途決定が必要。

### 主要エンティティ

- **SerializeField 更新リクエスト**: ターゲットパス、コンポーネント種別、フィールドパス、値、dry-run/保存フラグを含む。レスポンス要素を定義する元データ。
- **ターゲットオブジェクト**: シーン内GameObjectまたはPrefab内部オブジェクト。ヒエラルキー情報、所属シーン/Prefab、Dirty状態などを持つ。

---

## スコープ外 *(オプション)*

- コード生成やスクリプト編集によるSerializeField追加/削除。
- 複数フィールドを一括更新するバッチ処理。
- 依存スクリプトの再コンパイルや差分ビルドの自動化。

---

## 技術制約 *(該当する場合)*

- 対応Unityバージョンは2021LTS〜2023LTSのエディタ環境に限定する。
- MCPサーバ経由のリクエストは順序性が保証され、同一ターゲットへの競合更新はクライアント側でシリアル化される前提とする。

---

## 前提条件 *(該当する場合)*

- UnityプロジェクトにはPrefab Stage編集機能が有効であり、対象Prefabsはローカルファイルとしてアクセスできる。
- MCPクライアントはGameObjectパスやPrefabパスを取得できる既存のヒエラルキー/コンポーネント閲覧ツールを利用できる。

---

## 依存関係 *(該当する場合)*

- 既存の `get_hierarchy`、`list_components`、`get_component_values` などのツールから得られるパス・フィールド情報。
- MCPコマンド履歴/監査ログの永続化仕組み。

---

## 成功基準 *(必須)*

1. シーンおよびPrefabを対象にした代表的なSerializeField更新タスク（各5件）が、MCP経由で100%完了し追加の手作業を要さない。
2. dry-run機能を通じて、存在しないターゲットや型不一致を100%検出できる。
3. Prefab更新後の保存漏れによる差分消失が0件である。
