# 機能仕様書: Unity Profilerパフォーマンス計測

**機能ID**: `SPEC-1591581c`
**作成日**: 2025-01-17
**ステータス**: 下書き
**入力**: ユーザー説明: "Unity Profilerパフォーマンス計測機能をMCPツールとして提供"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - パフォーマンス計測の記録と保存 (優先度: P1)

開発者やQAエンジニアが、Unityアプリケーションの実行中にパフォーマンスデータを記録し、後から詳細に分析できるようにしたい。記録されたデータはUnityの標準Profiler Windowで開くことができ、CPU使用率、メモリ使用量、レンダリング性能などを時系列で確認できる。

**この優先度の理由**: パフォーマンス問題の特定と解決には、詳細なプロファイリングデータの記録が不可欠。これがなければパフォーマンス最適化作業そのものが成立しない。

**独立テスト**: MCPツールでプロファイリングを開始し、数秒間実行してから停止する。保存された.dataファイルがUnity Profiler Windowで正常に開けることを確認することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** Unityエディタが起動しており、MCPサーバーと接続している、**実行** LLMがパフォーマンス計測開始を指示、**結果** プロファイリングが開始され、セッションIDが返却される
2. **前提** プロファイリングが実行中、**実行** LLMがパフォーマンス計測停止を指示、**結果** プロファイリングが停止し、.dataファイルが指定された場所に保存される
3. **前提** .dataファイルが保存されている、**実行** Unity Profiler Windowでファイルを開く、**結果** 記録された期間のCPU、メモリ、レンダリングなどのプロファイリングデータが時系列グラフで表示される
4. **前提** 既にプロファイリングが実行中、**実行** LLMが再度パフォーマンス計測開始を指示、**結果** エラーメッセージが返却され、既存のセッションIDが通知される

---

### ユーザーストーリー2 - リアルタイムメトリクスの取得 (優先度: P2)

開発者が、Unityアプリケーションの実行中にリアルタイムでパフォーマンスメトリクス（CPU時間、メモリ使用量、GC回数、描画コール数など）を取得し、LLMがその場で分析・アドバイスできるようにしたい。

**この優先度の理由**: .dataファイル保存だけでなく、即座にメトリクスを取得できることで、LLMによる自動診断や、長時間実行中の監視が可能になる。P1で基本機能が確立されているため、P2として価値を追加する。

**独立テスト**: MCPツールでプロファイリングを開始し、リアルタイムメトリクス取得を要求すると、現在のCPU時間、メモリ使用量、GC回数などのメトリクスがJSON形式で即座に返却されることを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提** Unityエディタが起動している、**実行** LLMが利用可能なメトリクス一覧の取得を指示、**結果** CPU、メモリ、レンダリング、GCなどのカテゴリ別にメトリクス名の一覧が返却される
2. **前提** プロファイリングが実行中、**実行** LLMが現在のメトリクス取得を指示、**結果** 最新のCPU時間、メモリ使用量、GC回数、描画コール数などの数値がJSON形式で返却される
3. **前提** プロファイリングが実行中、**実行** LLMが特定のメトリクス（例: System Used Memory、Draw Calls Count）のみを指定して取得を指示、**結果** 指定されたメトリクスの値のみが返却される

---

### ユーザーストーリー3 - プロファイリング状態の確認 (優先度: P3)

開発者が、現在プロファイリングが実行中かどうか、いつ開始されたか、どのくらいの時間記録しているかを確認できるようにしたい。特に長時間実行する場合や、複数のLLMセッションで作業する場合に有用。

**この優先度の理由**: 状態確認は便利だが、P1とP2の機能だけでも十分に価値を提供できる。長時間監視や複数セッション対応のための補助機能として位置付ける。

**独立テスト**: プロファイリングを開始した後、状態確認を要求すると、実行中であること、セッションID、開始時刻、経過時間が返却されることを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提** プロファイリングが実行中でない、**実行** LLMがプロファイリング状態確認を指示、**結果** 実行中でないことを示す情報が返却される
2. **前提** プロファイリングが実行中、**実行** LLMがプロファイリング状態確認を指示、**結果** 実行中であること、セッションID、開始時刻、経過時間が返却される
3. **前提** プロファイリングが実行中、**実行** 自動停止時間（maxDurationSec）が設定されている場合、**結果** 状態確認時に残り時間も返却される

---

### エッジケース

- プロファイリング中にUnityエディタがクラッシュした場合、次回起動時に状態がリセットされるか？
- 保存先ディレクトリが存在しない、または書き込み権限がない場合、どのようなエラーメッセージが返されるか？
- プロファイリングを開始せずに停止を要求した場合、適切なエラーメッセージが返されるか？
- 長時間（数時間）のプロファイリングでメモリ使用量が過剰にならないか、自動的に制限されるか？
- 同一セッションIDで複数回停止を要求した場合、どのように処理されるか？

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはUnity Profilerによるパフォーマンスデータの記録を開始できる必要がある
- **FR-002**: システムはパフォーマンスデータの記録を停止し、.data形式でファイルに保存できる必要がある
- **FR-003**: 保存された.dataファイルはUnity Profiler Windowで開くことができる標準形式である必要がある
- **FR-004**: システムは現在のプロファイリング状態（実行中/停止中、セッションID、経過時間）を返却できる必要がある
- **FR-005**: システムは利用可能なパフォーマンスメトリクスの一覧を返却できる必要がある
- **FR-006**: システムは指定されたメトリクス（CPU時間、メモリ使用量、GC回数、描画コール数など）のリアルタイム値を取得できる必要がある
- **FR-007**: システムは既にプロファイリングが実行中の場合、新しい記録開始を拒否し、適切なエラーメッセージを返す必要がある
- **FR-008**: システムはプロファイリングの自動停止時間（maxDurationSec）を設定できる必要がある
- **FR-009**: 保存されたファイルは既存のスクリーンショット・動画と同じ場所（.unity/capture/）に統一的に保存される必要がある
- **FR-010**: システムはセッションごとに一意のIDを生成し、停止時にそのIDで特定できる必要がある

### 主要エンティティ

- **プロファイリングセッション**: パフォーマンス記録の単位。セッションID、開始時刻、ステータス（実行中/停止）、保存先パスを持つ
- **メトリクス**: パフォーマンスの測定値。カテゴリ（CPU、メモリ、レンダリング、GCなど）、名前、現在値、単位を持つ
- **プロファイルデータファイル**: 記録されたパフォーマンスデータを保存する.data形式のファイル。Unity Profiler Windowで開ける

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- ディーププロファイリング（Deep Profiling）の自動有効化
- フレーム範囲の指定（特定のフレーム区間のみ記録）
- メトリクスの統計サマリー生成（平均値、最大値、最小値、標準偏差）
- グラフ画像の自動生成
- 複数の.dataファイルの比較機能
- プロファイリングデータのCSVエクスポート

---

## 技術制約 *(該当する場合)*

- Unity Profiler APIはUnityエディタ環境でのみ動作し、ビルド済みアプリケーションでは使用できない
- .dataファイルの保存にはUnityEditorInternal.ProfilerDriver APIを使用する（エディタ専用）
- リアルタイムメトリクス取得にはUnity.Profiling.ProfilerRecorder APIを使用する
- 保存先は.unity/capture/配下に固定され、他の場所への保存はサポートしない

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- Unityエディタが起動しており、MCPサーバーと正常に接続されている
- .unity/capture/ディレクトリが存在するか、システムが自動作成できる
- ユーザーがプロファイリングを実行する権限を持っている

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- MCPサーバーとUnityエディタ間の双方向通信機能
- ワークスペースルート解決機能（Nodeからの `workspaceRoot` 優先／未受領時は `.unity/` 探索）
- 既存のハンドラーアーキテクチャ（VideoCapture、Screenshotと同様のパターン）

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. LLMがパフォーマンス計測を開始・停止でき、保存された.dataファイルがUnity Profiler Windowで正常に開けること
2. リアルタイムメトリクスの取得が1秒以内に完了し、正確な数値が返却されること
3. 長時間（10分以上）のプロファイリングでもメモリリークやクラッシュが発生しないこと
4. 自動テスト（CI/CD）環境でパフォーマンスリグレッションを検出できること（記録→保存→分析のフローが完全に自動化可能）
5. 既存のMCPツール（Screenshot、Video）と同じ操作感で使用でき、保存先も統一されていること

---

## ⚡ クイックガイドライン

- ✅ ユーザーが「何を」必要とし「なぜ」必要なのかに焦点を当てる
- ❌ 「どのように」実装するかを避ける (技術スタック、API、コード構造なし)
- 👥 ビジネス関係者向けに記述 (開発者向けではない)
