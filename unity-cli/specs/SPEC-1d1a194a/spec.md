# 機能仕様書: MCP Capabilities正常認識

**機能ID**: `SPEC-1d1a194a`
**作成日**: 2025-11-18
**ステータス**: 下書き
**入力**: Claude CodeなどMCPクライアントでunity-cliのツールが「Capabilities: none」と表示される問題、およびツール数上限（100件）クライアントで接続できない問題を修正する

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - ツール一覧が正常に認識される (優先度: P1)

MCPクライアント（Claude Code等）でunity-cliに接続したとき、107個のツールがすべて正常に認識され、ユーザーがUnityエディタの操作を即座に開始できる。

**この優先度の理由**: ツール認識はMCPサーバーの基本機能であり、これが動作しない場合、ユーザーは一切の操作ができない。最優先で解決すべき問題。

**独立テスト**: MCPクライアントの接続画面で「Capabilities: tools」と表示され、`tools/list`リクエストで107個のツール定義が返却されることをテストできる。

**受け入れシナリオ**:

1. **前提** unity-cliがインストールされている、**実行** MCPクライアント（Claude Code）で接続、**結果** 「Capabilities: tools」と表示される
2. **前提** unity-cliに接続済み、**実行** `tools/list`リクエストを送信、**結果** 107個のツール定義が正常に返却される
3. **前提** MCPクライアントでツール一覧を表示、**実行** `ping`ツールを実行、**結果** Unity Editorとの接続が確認できる

---

### ユーザーストーリー2 - エラーなく接続が完了する (優先度: P2)

MCPクライアントでunity-cliに接続したとき、コンソールエラーやワーニングが発生せず、クリーンな接続状態が維持される。

**この優先度の理由**: エラーメッセージはユーザー体験を損ない、トラブルシューティングの手間を増やす。ツール認識（P1）の次に重要。

**独立テスト**: 接続時のMCPサーバーログとクライアントログを確認し、エラー/ワーニングが0件であることをテストできる。

**受け入れシナリオ**:

1. **前提** unity-cliを起動、**実行** MCPクライアントで接続、**結果** サーバーログにエラー/ワーニングが出力されない
2. **前提** MCPクライアントで接続済み、**実行** ツール一覧を表示、**結果** クライアントのコンソールにエラー/ワーニングが表示されない
3. **前提** Unity Editorが起動していない状態、**実行** unity-cliに接続、**結果** 接続リトライのログのみ表示され、致命的エラーは発生しない

---

### ユーザーストーリー3 - トラブルシューティングガイドが提供される (優先度: P3)

「Capabilities: none」問題が発生した場合に、ユーザーが自力で解決できるトラブルシューティング情報がREADME.mdに記載されている。

**この優先度の理由**: P1/P2で根本原因を修正すれば問題は発生しないが、過去バージョンユーザーやエッジケースのためのガイドとして価値がある。

**独立テスト**: README.mdに「Capabilities: none」セクションが存在し、症状説明・原因・解決策が記載されていることをテストできる。

**受け入れシナリオ**:

1. **前提** ユーザーが「Capabilities: none」問題に遭遇、**実行** README.mdのTroubleshootingセクションを参照、**結果** 症状の説明と解決策が記載されている
2. **前提** README.mdを読んだユーザー、**実行** 最新版へのアップデート手順を実施、**結果** 問題が解消される
3. **前提** トラブルシューティングガイドを読んだユーザー、**実行** Unity Editorの接続確認手順を実施、**結果** 接続状態を診断できる

---

### ユーザーストーリー4 - ツール数上限クライアントでも接続できる (優先度: P1)

ツール数上限（100件など）を持つMCPクライアントでも、利用者がカテゴリ単位で公開ツールを絞り込むことで、unity-cliを有効化して運用できる。

**この優先度の理由**: サーバーを有効化できない状態では、機能が存在しても実利用できないため、接続可否に直結する最優先課題。

**独立テスト**: カテゴリ指定の環境変数を設定して`tools/list`を実行し、公開ツールが指定カテゴリに限定されること、および非公開ツールが`tools/call`で拒否されることを確認できる。

**受け入れシナリオ**:

1. **前提** カテゴリ指定環境変数が未設定、**実行** `tools/list`を実行、**結果** 従来どおり全ツールが返却される
2. **前提** 公開カテゴリを指定、**実行** `tools/list`を実行、**結果** 指定カテゴリのツールのみ返却される
3. **前提** 非公開カテゴリを指定、**実行** `tools/list`を実行、**結果** 除外カテゴリのツールが返却されない
4. **前提** 非公開ツール名が分かっている、**実行** `tools/call`で直接実行、**結果** `Tool not found`として拒否される

---

### エッジケース

- MCP SDK v0.6.1でcapabilityに空オブジェクトを設定した場合、`assertRequestHandlerCapability`エラーが発生するか?
- リモートに古いバージョン（v2.40.2以前）が残っている場合、npmキャッシュが影響を与えるか?
- Unity Editorが起動していない状態でunity-cliに接続した場合、capability認識に影響するか?
- カテゴリ指定に未知の値が含まれる場合、既知カテゴリのみ有効化し未知値は警告して無視できるか?
- include/excludeの両方に同一カテゴリを指定した場合、excludeが最終的に優先されるか?

## 要件 *(必須)*

### 機能要件

- **FR-001**: MCPサーバーは`capabilities.tools`のみを宣言し、`resources`と`prompts`は省略しなければならない
- **FR-002**: MCPサーバーは`ListToolsRequestSchema`ハンドラーを登録し、107個のツール定義を返却しなければならない
- **FR-003**: MCPサーバーは未サポートのcapability（`resources`, `prompts`）に対応するハンドラーを登録してはならない
- **FR-004**: MCP SDK v0.6.1の`assertRequestHandlerCapability`チェックに違反してはならない
- **FR-005**: トラブルシューティングガイドは「Capabilities: none」の症状・原因・解決策を含まなければならない
- **FR-006**: システムはカテゴリ指定（include）で`tools/list`の公開対象を限定できなければならない
- **FR-007**: システムはカテゴリ指定（exclude）で`tools/list`の公開対象から除外できなければならない
- **FR-008**: include/excludeを同時指定した場合、includeで候補を絞った後にexcludeを適用しなければならない
- **FR-009**: カテゴリ指定が未設定の場合は、従来どおり全ツールを公開しなければならない
- **FR-010**: 非公開扱いになったツールは`tools/call`で直接指定しても実行してはならない
- **FR-011**: 未知のカテゴリ指定はエラー停止せず警告して無視しなければならない
- **FR-012**: 設定ドキュメントはツール数上限クライアント向けにカテゴリ絞り込みの設定例を提供しなければならない

### 主要エンティティ

- **MCPサーバーcapabilities**: MCPサーバーが提供する機能の宣言（`tools`, `resources`, `prompts`）。未サポートのcapabilityは省略する。
- **ツールハンドラー**: MCPリクエストを処理する関数。capabilityとの整合性が必要。
- **トラブルシューティングガイド**: README.md内のセクション。症状・原因・解決策を記載。
- **ツール公開ポリシー**: include/excludeカテゴリ指定に基づき、`tools/list`と`tools/call`の公開範囲を一貫して制御するルール。

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- MCP Compliance Suite（OpenAI提供）による自動テスト
- resources/promptsのcapability実装（現在は未サポート）
- リアルタイム診断ツール（capability状態の可視化）

---

## 技術制約 *(該当する場合)*

- MCP SDK v0.6.1の仕様に準拠する必要がある（capability宣言とハンドラー登録の整合性）
- npm package配布のため、`unity-cli/`ディレクトリ内の変更のみ対象
- Unity Package（UPM）側の変更はスコープ外

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- MCPクライアント（Claude Code等）がMCP SDK v0.6.1以降をサポートしている
- npm packageが正常にビルド・公開されている
- Unity Editor（2020.3 LTS以降）がインストールされている

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- @modelcontextprotocol/sdk v0.6.1以降
- semantic-release（バージョン自動決定・リリース自動化）
- GitHub Actions（CI/CDパイプライン）

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. Claude Codeで接続したとき「Capabilities: tools」と表示され、「Capabilities: none」が表示されない
2. カテゴリ指定が未設定の場合、`tools/list`で全ツール定義が返却される
3. 既存の68個のテストがすべて成功する（リグレッションなし）
4. README.mdのTroubleshootingセクションに「Capabilities: none」ガイドが記載されている
5. npm publishが成功し、最新版がnpmレジストリに公開される
6. カテゴリ指定設定により、ツール数上限クライアントで受け入れ可能な件数まで`tools/list`を減らせる
7. 非公開ツールは`tools/call`で拒否され、`tools/list`の公開範囲と矛盾しない
8. カテゴリフィルタの挙動を検証する自動テスト（unit）が追加され、CIで合格する

---

## ⚡ クイックガイドライン

- ✅ ユーザーが「何を」必要とし「なぜ」必要なのかに焦点を当てる
- ❌ 「どのように」実装するかを避ける (技術スタック、API、コード構造なし)
- 👥 ビジネス関係者向けに記述 (開発者向けではない)
