# 機能仕様書: Unity MCP基本接続機能

**機能ID**: `SPEC-9d2bc43b`
**作成日**: 2025-10-17
**ステータス**: 完了
**入力**: ユーザー説明: "Unity MCPサーバーとUnity Editorの基本接続機能"

## 実行フロー (main)
```
1. 入力からユーザー説明を解析
   → 完了: "Unity MCPサーバーとUnity Editorの基本接続機能"
2. 説明から主要概念を抽出
   → アクター: Unity開発者、LLMユーザー（Claude/Codex等）
   → アクション: 自動接続、接続状態確認、自動再接続
   → データ: JSON-RPCメッセージ、エディタ状態
   → 制約: localhost限定、Unity 2020.3 LTS以降、Node.js 18+
3. 不明確な側面: なし（既存実装のSpec化）
4. ユーザーシナリオ＆テストセクションを記入
   → 3つの主要ユーザーストーリー定義済み
5. 機能要件を生成
   → 12個の機能要件をテスト可能な形式で定義
6. 主要エンティティを識別
   → TCP接続、JSON-RPCメッセージ、エディタ状態
7. レビューチェックリストを実行
   → 技術詳細は参考実装セクションに分離
   → 要件はテスト可能
8. 戻り値: SUCCESS (計画準備完了)
```

---

## ⚡ クイックガイドライン
- ✅ ユーザーが「何を」必要とし「なぜ」必要なのかに焦点を当てる
- ❌ 「どのように」実装するかを避ける (技術スタック、API、コード構造なし)
- 👥 ビジネス関係者向けに記述 (開発者向けではない)

---

## 機能概要

LLMクライアント（Claude、Codex等）がUnity Editorを自動化するための基本接続機能。Unity Editorとの安定した通信を確立・維持し、開発者がゼロコンフィグで自動化タスクを開始できるようにする。さらに、コンパイル状態の監視により、コードエラーの早期検出と自動修正を可能にする。

### ビジネス価値

- **開発者の生産性向上**: Unity Editorの操作をLLMで自動化し、反復作業を削減
- **信頼性**: 接続断・タイムアウト時の自動再接続により、長時間作業でも安定動作
- **ゼロコンフィグ**: デフォルト設定で即座に利用可能、設定なしで動作開始
- **コード品質向上**: コンパイルエラーをリアルタイムに検出し、LLMによる自動修正を支援

---

## ユーザーシナリオ＆テスト

### 主要ユーザーストーリー

#### US-1: 自動接続確立

**AS** Unity開発者
**I WANT** Unity Editorを起動するだけでMCPサーバーと自動接続したい
**SO THAT** 手動設定なしですぐに自動化タスクを開始できる

**受け入れ基準**:
- Unity Editor起動時、サーバーが自動的に待機状態になる
- MCPクライアント起動時、Unity Editorへ自動接続する
- 接続失敗時、一定時間後に自動リトライする

#### US-2: 接続状態の確認

**AS** LLMユーザー
**I WANT** Unity Editorとの接続状態を確認したい
**SO THAT** コマンド実行前に接続が有効か判断できる

**受け入れ基準**:
- 接続疎通確認コマンドが利用可能
- Unityのモード（Play/Edit）状態を取得できる
- 妥当な時間内にレスポンスが返る

#### US-3: 接続断時の自動復旧

**AS** Unity開発者
**I WANT** Unity Editor再起動後、MCPサーバーが自動再接続してほしい
**SO THAT** 手動でMCPクライアントを再起動する必要がない

**受け入れ基準**:
- Unity Editor再起動を検知し、自動再接続を試行する
- 再接続成功後、以前の状態から作業を継続できる
- 接続エラー時、明確なエラーメッセージと解決策を提示する

#### US-4: コンパイル状態の監視

**AS** LLMユーザー
**I WANT** Unity Editorのコンパイルエラーをリアルタイムに検出したい
**SO THAT** コードエラーを即座に把握し、自動修正を実行できる

**受け入れ基準**:
- コンパイル状態（成功/失敗/進行中）を取得できる
- コンパイルエラー・警告の詳細メッセージを取得できる
- エラー発生時、ファイル名・行番号・エラー内容が明確に表示される

### 受け入れシナリオ

1. **前提** Unity Editorが起動していない、**実行** Unity Editorを起動、**結果** MCPサーバーが接続可能状態になる
2. **前提** Unity Editorが起動中、**実行** MCPクライアントを起動、**結果** 自動的にUnity Editorと接続される
3. **前提** 接続確立済み、**実行** 接続疎通確認コマンド実行、**結果** 接続成功レスポンスが返る
4. **前提** 接続確立済み、**実行** Unity Editorを再起動、**結果** MCPサーバーが自動再接続する
5. **前提** 接続確立済み、**実行** エディタ状態取得コマンド実行、**結果** 現在のPlay/Edit状態が返る
6. **前提** 接続確立済み、**実行** コンパイル状態取得コマンド実行、**結果** コンパイル状態とエラー・警告の詳細が返る
7. **前提** コンパイルエラー発生中、**実行** コンパイル状態取得コマンド実行、**結果** エラーメッセージ、ファイル名、行番号が明確に表示される

### エッジケース

- Unity Editorが起動していない場合、接続エラーメッセージと解決策が表示されるか?
- ネットワークタイムアウトが発生した場合、自動リトライが実行されるか?
- 複数のMCPクライアントが同時接続を試みた場合、どのように処理されるか?
- Unity Editorがクラッシュした場合、MCPサーバーは適切にエラーを検知するか?
- コンパイル中にコンパイル状態を取得した場合、進行中状態が正しく返されるか?
- 大量のコンパイルエラーがある場合、エラーメッセージの取得数を制限できるか?

---

## 要件

### 機能要件

- **FR-001**: システムはUnity Editor起動時に自動的に接続待機状態になる必要がある
- **FR-002**: システムはMCPクライアント起動時にUnity Editorへ自動接続する必要がある
- **FR-003**: システムは接続失敗時に自動リトライを実行する必要がある
- **FR-004**: システムは接続疎通確認コマンドを提供する必要がある
- **FR-005**: システムはUnityエディタの現在の状態（Play/Edit）を取得できる必要がある
- **FR-006**: システムはUnity Editor再起動時に自動再接続を試行する必要がある
- **FR-007**: システムは接続エラー時に明確なエラーメッセージを表示する必要がある
- **FR-008**: システムはエラーメッセージに解決策を含める必要がある
- **FR-009**: システムはデフォルト設定で動作可能である必要がある（ゼロコンフィグ）
- **FR-010**: システムはローカルホストからの接続のみを許可する必要がある
- **FR-011**: システムは接続再試行時に指数バックオフを使用する必要がある
- **FR-012**: システムは各コマンドに対してタイムアウトを設定できる必要がある
- **FR-013**: システムはUnityのコンパイル状態（成功/失敗/進行中）を取得できる必要がある
- **FR-014**: システムはコンパイルエラーと警告の詳細メッセージを取得できる必要がある
- **FR-015**: システムはエラーメッセージにファイル名と行番号を含める必要がある
- **FR-016**: システムはコンパイルメッセージの取得数を制限できる必要がある

### 非機能要件

#### 性能要件

- **NFR-001**: 初回接続確立は3秒以内に完了する必要がある
- **NFR-002**: 接続疎通確認のレスポンスは100ミリ秒以内である必要がある
- **NFR-003**: コマンドタイムアウトはデフォルト30秒である必要がある
- **NFR-004**: コマンドタイムアウトは設定変更可能である必要がある

#### 可用性要件

- **NFR-005**: Unity Editor正常動作時、再接続成功率は95%以上である必要がある
- **NFR-006**: すべての接続エラーで自動リトライが試行される必要がある
- **NFR-007**: 再接続試行の最大間隔は30秒である必要がある

#### セキュリティ要件

- **NFR-008**: デフォルトでlocalhostのみ接続を許可する必要がある
- **NFR-009**: 将来的に認証機能を追加できる設計である必要がある

#### コンパイル監視要件

- **NFR-010**: コンパイル状態取得のレスポンスは500ミリ秒以内である必要がある
- **NFR-011**: デフォルトでエラー・警告メッセージは50件まで取得できる必要がある

### 主要エンティティ

- **TCP接続**: Unity EditorとMCPサーバー間の通信チャネル。接続状態、再試行カウント、タイムアウト設定を保持
- **JSON-RPCメッセージ**: コマンドとレスポンスを表すメッセージ。メソッド名、パラメータ、結果を含む
- **エディタ状態**: Unity Editorの現在の動作モード。Play/Edit状態、接続可能性を表す
- **コンパイル状態**: Unityのコンパイル状況。成功/失敗/進行中の状態、エラー・警告メッセージ、ファイル名、行番号を含む

---

## スコープ外

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- リモートUnity Editorへの接続
- 複数Unity Editorの同時接続
- 暗号化通信（TLS/SSL）
- 認証・認可機能
- 接続ロギング・モニタリングダッシュボード

---

## 技術制約

- Unity 2020.3 LTS以降をサポート対象とする
- Node.js 18以降の環境で動作する
- TCP通信はJSON-RPCプロトコルに準拠する
- 初期バージョンは認証なしで動作する

---

## 参考実装

本仕様は既存実装を文書化したものです。参考実装:

- `unity-cli/src/core/unityConnection.js`: 接続管理
- `unity-cli/src/handlers/system/SystemPingToolHandler.js`: 接続疎通確認
- `unity-cli/src/handlers/playmode/PlaymodeGetStateToolHandler.js`: エディタ状態取得
- `unity-cli/src/handlers/system/SystemRefreshAssetsToolHandler.js`: アセット更新
- `unity-cli/src/handlers/system/SystemGetCommandStatsToolHandler.js`: コマンド統計取得
- `unity-cli/src/handlers/compilation/CompilationGetStateToolHandler.js`: コンパイル状態取得
- `UnityCliBridge/Packages/unity-cli-bridge/Editor/Core/UnityCliBridge.cs`: Unity側サーバー

---

## レビュー＆受け入れチェックリスト

### コンテンツ品質
- [x] 実装詳細なし (言語、フレームワーク、API)
- [x] ユーザー価値とビジネスニーズに焦点
- [x] 非技術関係者向けに記述
- [x] すべての必須セクション完成

### 要件完全性
- [x] [要明確化]マーカーが残っていない
- [x] 要件はテスト可能で曖昧さがない
- [x] 成功基準は測定可能
- [x] スコープが明確に境界付けられている
- [x] 依存関係と前提条件が識別されている

---

## 実行ステータス

- [x] ユーザー説明を解析済み
- [x] 主要概念を抽出済み
- [x] 曖昧さをマーク済み（なし）
- [x] ユーザーシナリオを定義済み
- [x] 要件を生成済み
- [x] エンティティを識別済み
- [x] レビューチェックリスト合格

**ステータス**: 完了
