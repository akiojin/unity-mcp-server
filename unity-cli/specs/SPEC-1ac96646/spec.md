# 機能仕様書: 4層リリースフロー（feature → develop → release/* → main）

**機能ID**: `SPEC-1ac96646`
**作成日**: 2025-11-07
**最終更新**: 2025-11-09
**ステータス**: 実装完了
**入力**: ユーザー説明: "4層リリースフロー（feature → develop → release/* → main）の実装"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - developブランチへのPR自動マージ (優先度: P1)

開発者として、featureブランチでの作業が完了したら、developブランチへのPRを作成し、CI/CDチェックが成功したら自動的にマージされることで、手動マージの手間を削減し、開発速度を向上させたい。

**この優先度の理由**: これは3層フローの基盤となる機能です。developブランチが正しく機能しなければ、後続のリリースフローが成立しません。最も基本的で重要な機能のため、P1としています。

**独立テスト**: finish-feature.shスクリプトを実行してdevelopへのPRを作成し、CI/CDチェック成功後に自動マージされることを確認することで完全にテストできます。この機能だけで、開発者はfeatureブランチからdevelopへスムーズに統合できる価値を提供します。

**受け入れシナリオ**:

1. **前提** featureブランチで作業が完了、**実行** finish-feature.shを実行、**結果** developをベースとしたPRが作成される
2. **前提** developへのPRが作成済み、**実行** CI/CDチェックがすべて成功、**結果** PRが自動的にdevelopにマージされる
3. **前提** developへのPRが作成済み、**実行** CI/CDチェックが失敗、**結果** PRは自動マージされず、コメントで失敗を通知される

---

### ユーザーストーリー2 - /releaseコマンドによる手動リリース (優先度: P2)

プロジェクトマネージャー/リリース担当者として、developブランチの変更を蓄積した後、意図的なタイミングでリリースを開始したい。/releaseコマンドを実行すると、release/vX.Y.Zブランチが作成され、そこでsemantic-releaseが実行されてバージョン決定とCHANGELOG生成が行われる。その後、release/*ブランチからmainへ自動マージされることで、リリースプロセスを自動化したい。

**この優先度の理由**: リリース頻度の削減という主要な目標を達成するための核心機能です。developブランチへの統合ができた後、次に重要なのは、意図的なタイミングでのリリース実行です。

**独立テスト**: /releaseコマンドを実行し、release/vX.Y.Zブランチが作成され、semantic-releaseが実行され、mainへ自動マージされることを確認することでテストできます。この機能により、リリース担当者は適切なタイミングでリリースをコントロールできる価値を提供します。

**受け入れシナリオ**:

1. **前提** developブランチに複数のfeatureがマージ済み、**実行** /releaseコマンドを実行、**結果** release/vX.Y.Zブランチが作成され、developからのPRが作成される
2. **前提** release/* PR作成済み、**実行** CI/CDチェック成功、**結果** semantic-releaseが実行され、バージョン決定とCHANGELOG生成が完了する
3. **前提** semantic-release完了、**実行** release.ymlワークフロー実行、**結果** release/*ブランチがmainに自動マージされる
4. **前提** mainマージ完了、**実行** バックマージワークフロー実行、**結果** mainの変更がdevelopにバックマージされる

---

### ユーザーストーリー3 - 自動リリース成果物配信 (優先度: P3)

エンドユーザー/パッケージ利用者として、mainブランチへのマージ後、自動的にMCPサーバーがnpmjs.comに公開され、LSPサーバーが全プラットフォームでビルドされ、GitHub Releaseが作成されることで、最新バージョンをすぐに利用できるようにしたい。

**この優先度の理由**: リリースフローの自動化により、手動作業を削減し、リリースの一貫性を保証します。mainへのマージが正しく動作した後に必要となる機能のため、P3としています。

**独立テスト**: mainブランチへのマージを実行し、semantic-releaseが自動的に実行され、npmjs.comへのpublish、LSPサーバーのビルド、GitHub Releaseの作成がすべて完了することを確認することでテストできます。この機能により、エンドユーザーは最新バージョンを即座に利用できる価値を提供します。

**受け入れシナリオ**:

1. **前提** release/*→ main マージ済み、**実行** semantic-releaseが自動実行（release/*ブランチ上）、**結果** package.json、Unity Package、CHANGELOG.mdが更新され、タグが作成される
2. **前提** semantic-release完了、**実行** GitHub Releaseが作成、**結果** MCPサーバーがnpmjs.comに自動publishされる
3. **前提** GitHub Release作成済み、**実行** LSPサーバービルドジョブ実行、**結果** 全プラットフォーム（linux-x64, osx-x64, osx-arm64, win-x64）のバイナリがGitHub Releaseに添付される

---

### ユーザーストーリー4 - 既存PR移行 (優先度: P4)

開発者として、現在mainベースで作成されている16個のfeature PRを、新しいdevelopブランチベースに一括変更することで、既存の作業を中断せずに新しいフローに移行したい。

**この優先度の理由**: 既存作業の移行は重要ですが、新しいフローの基盤が整ってから実施すべきです。P1〜P3の機能が動作確認できた後に実施するため、P4としています。

**独立テスト**: PR移行スクリプトを実行し、16個のPRのベースブランチがすべてdevelopに変更され、変更後のPRが正常に動作することを確認することでテストできます。この機能により、開発者は既存作業を失わずに新フローに移行できる価値を提供します。

**受け入れシナリオ**:

1. **前提** mainベースのfeature PRが16個存在、**実行** PR移行スクリプトを実行、**結果** すべてのPRのベースブランチがdevelopに変更される
2. **前提** PRのベースブランチ変更完了、**実行** CI/CDチェック再実行、**結果** すべてのPRでチェックが正常に動作する
3. **前提** 移行後のPRが1つ成功、**実行** auto-mergeワークフロー実行、**結果** developに正常にマージされる

---

### ユーザーストーリー5 - OpenUPM自動配信 (優先度: P5)

Unity開発者として、mainブランチへのリリース時にOpenUPMパッケージレジストリに自動配信されることで、Unity Package Manager経由で簡単にインストールできるようにしたい。また、OpenUPMのパッケージページで十分な情報（README、homepage）が表示されることで、パッケージの用途と使い方を理解したい。

**この優先度の理由**: OpenUPM配信はエンドユーザー体験を向上させますが、npm publishとLSPビルドが完了した後に追加する付加価値機能のため、P5としています。

**独立テスト**: mainブランチへのマージ後、OpenUPM側のビルドパイプラインが自動的にトリガーされ、パッケージがOpenUPMレジストリに公開され、パッケージページにREADMEとhomepageが正しく表示されることを確認することでテストできます。この機能により、Unity開発者はUPM経由で簡単にインストールできる価値を提供します。

**受け入れシナリオ**:

1. **前提** mainブランチにリリースがマージ済み、**実行** OpenUPM側がGitHubタグを検出、**結果** OpenUPMビルドパイプラインが自動実行される
2. **前提** OpenUPMビルド完了、**実行** OpenUPMパッケージページを確認、**結果** 最新バージョンが表示され、README内容とhomepageリンクが正しく表示される
3. **前提** OpenUPM配信完了、**実行** Unity EditorでUPM経由でインストール、**結果** パッケージが正常にインストールされる

---

### エッジケース

- developブランチがまだ存在しない場合、どのように作成するか？
  - **対応**: mainブランチの最新コミットからdevelopブランチを作成し、GitHub上でデフォルトブランチをdevelopに変更する

- /releaseコマンド実行時にdevelopとmainに差分がない場合、何が起こるか？
  - **対応**: リリースノートプレビューで「変更なし」を表示し、PR作成をスキップする

- semantic-release実行中にエラーが発生した場合、どのように処理するか？
  - **対応**: リリースジョブを失敗させ、GitHub上でエラー通知を表示。手動介入が必要

- LSPサーバービルドが一部のプラットフォームで失敗した場合、どうするか？
  - **対応**: 成功したプラットフォームのバイナリのみGitHub Releaseに添付し、失敗したプラットフォームはエラーログを残す

- PR移行スクリプト実行中にネットワークエラーが発生した場合、どうするか？
  - **対応**: 移行済みPRをログに記録し、リトライ時にスキップする。べき等性を保証

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、finish-feature.shスクリプト実行時にdevelopブランチをベースとしたPRを作成する必要がある
- **FR-002**: システムは、developへのPRに対してCI/CDチェック成功時に自動マージを実行する必要がある
- **FR-003**: システムは、mainへのPRに対して自動マージを実行してはならない（手動承認必須）
- **FR-004**: システムは、/releaseコマンド実行時にrelease/vX.Y.Zブランチを作成し、developからのPRを作成する必要がある
- **FR-005**: システムは、release/*ブランチ上でsemantic-releaseを自動実行し、package.json、Unity Package、CHANGELOG.mdを更新し、タグを作成する必要がある
- **FR-006**: システムは、semantic-release完了後にrelease/*ブランチをmainに自動マージする必要がある
- **FR-007**: システムは、mainマージ後にdevelopへバックマージする必要がある
- **FR-008**: システムは、GitHub Release作成時にMCPサーバーをnpmjs.comに自動publishする必要がある
- **FR-009**: システムは、LSPサーバーを全プラットフォーム（linux-x64, osx-x64, osx-arm64, win-x64）でビルドし、GitHub Releaseに添付する必要がある
- **FR-010**: システムは、PR移行スクリプト実行時に既存16個のfeature PRのベースブランチをdevelopに一括変更する必要がある
- **FR-011**: システムは、PR移行後もCI/CDチェックが正常に動作することを保証する必要がある
- **FR-012**: GitHub上のデフォルトブランチはdevelopである必要がある
- **FR-013**: CLAUDE.md、README.md、quickstart.mdは4層ブランチフロー（feature → develop → release/* → main）を反映した内容に更新される必要がある
- **FR-014**: システムは、Unity Packageのpackage.jsonに`homepage`フィールドを含める必要がある（OpenUPMパッケージページでの情報表示のため）
- **FR-015**: システムは、Unity PackageルートにREADME.mdを配置する必要がある（OpenUPMパッケージページでのREADME埋め込みのため）

### 主要エンティティ

- **ブランチ**: feature, develop, release/*, mainの4層構造。featureはdevelopから派生、release/*はdevelopから作成され、mainは安定版リリース専用
- **プルリクエスト**: feature → develop（自動マージ）、develop → release/*（/releaseコマンドで作成）、release/* → main（自動マージ）、main → develop（バックマージ）の4種類
- **リリース成果物**: MCPサーバー（npm）、LSPサーバー（全プラットフォームバイナリ）、Unity Package、CHANGELOG、タグ、OpenUPMパッケージ
- **CI/CDワークフロー**: auto-merge（developのみ）、release（mainのみ）、unity-cli-publish（GitHub Release作成時）
- **パッケージメタデータ**: package.json（homepage、version）、README.md（パッケージルート配置）

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- ホットフィックスブランチ（hotfix → main → develop）
- ロールバック機能（リリース後に問題が発覚した場合の自動ロールバック）
- マルチバージョンサポート（複数のメジャーバージョンの並行保守）

---

## 技術制約 *(該当する場合)*

- GitHub Actionsが利用可能である必要がある
- gh CLI（GitHub CLI）がインストールされている必要がある
- npm publishにはnpmjs.comのアクセストークンが必要
- LSPサーバービルドには.NET SDKが必要
- semantic-releaseはConventional Commits規約に依存する

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- 既存のGitHub Actionsワークフロー（auto-merge.yml、release.yml、unity-cli-publish.yml）が動作している
- semantic-release設定（.releaserc.json）が存在する
- finish-feature.shスクリプトが存在する
- Conventional Commits規約に従ったコミットメッセージが使用されている

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- **GitHub Actions**: CI/CD実行基盤
- **semantic-release**: 自動バージョニング＆リリースノート生成
- **gh CLI**: PR操作の自動化
- **npm**: MCPサーバーの配信
- **.NET SDK**: LSPサーバーのビルド
- **Unity Recorder**: 動画キャプチャ（既存依存関係）

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. **リリース頻度の削減**: featureマージごとのリリースから、意図的なタイミングでのリリース（週1回〜月1回程度）に削減される
2. **自動マージの成功率**: developへのPRの95%以上がCI/CDチェック成功後に自動マージされる
3. **リリース成果物の完全性**: mainマージ後、100%のケースでMCPサーバー（npm）、LSPサーバー（全プラットフォーム）、GitHub Releaseが正常に作成される
4. **PR移行の成功率**: 既存16個のPRの100%がdevelopベースに移行され、CI/CDチェックが正常に動作する
5. **リリース所要時間**: /releaseコマンド実行からGitHub Release作成まで、平均30分以内に完了する
6. **ドキュメント整合性**: CLAUDE.md、README.md、quickstart.mdが3層フローを正確に反映し、開発者が迷わずフローを理解できる
7. **OpenUPM配信の信頼性**: mainマージ後、OpenUPMビルドが自動的にトリガーされ、パッケージページでREADMEとhomepageが正しく表示される（100%のケース）

**成功基準の測定方法**:

1. **リリース頻度**: GitHub Releaseの作成間隔を計測（平均7日以上）
2. **自動マージ成功率**: auto-mergeワークフロー成功回数 ÷ 実行回数 × 100（95%以上）
3. **リリース成果物**: release.ymlとunity-cli-publish.ymlのジョブ成功率（100%）
4. **PR移行成功率**: 移行後のPRのCI/CDチェック成功数 ÷ 16 × 100（100%）
5. **リリース所要時間**: /release実行タイムスタンプ 〜 GitHub Release作成タイムスタンプの差分（30分以内）
6. **ドキュメント整合性**: レビューチェックリストで確認（100%一致）
7. **OpenUPM配信**: OpenUPMパッケージページでREADMEとhomepageが表示されることを手動確認（各リリースで確認）

---

## ⚡ クイックガイドライン

- ✅ ユーザーが「何を」必要とし「なぜ」必要なのかに焦点を当てる
- ❌ 「どのように」実装するかを避ける (技術スタック、API、コード構造なし)
- 👥 ビジネス関係者向けに記述 (開発者向けではない)
