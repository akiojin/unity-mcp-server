name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write
  checks: write

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Git credentials
        env:
          PUSH_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${PUSH_TOKEN}@github.com/${{ github.repository }}.git"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create release work branch
        id: release_branch
        run: |
          set -euo pipefail
          BRANCH="semrel/${GITHUB_RUN_ID}"
          echo "RELEASE_BRANCH=$BRANCH" >> "$GITHUB_ENV"
          git checkout -b "$BRANCH"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
          HUSKY: 0
        run: npx semantic-release

      - name: Capture release commit metadata
        id: release_commit
        run: |
          set -euo pipefail
          RELEASE_SHA=$(git rev-parse HEAD)
          echo "RELEASE_SHA=$RELEASE_SHA" >> "$GITHUB_ENV"
          echo "sha=$RELEASE_SHA" >> "$GITHUB_OUTPUT"

      - name: Record coverage test start
        run: echo "TEST_STARTED_AT=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_ENV"

      - name: Install server dependencies
        working-directory: mcp-server
        run: npm ci

      - name: Run coverage tests
        working-directory: mcp-server
        run: |
          set -euo pipefail
          npm run test:ci

      - name: Publish Test Coverage check-run
        env:
          STATUS_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          RELEASE_SHA: ${{ env.RELEASE_SHA }}
          TEST_STARTED_AT: ${{ env.TEST_STARTED_AT }}
        run: |
          set -euo pipefail
          if [ -z "$RELEASE_SHA" ]; then
            echo "Missing release commit SHA; cannot publish status." >&2
            exit 1
          fi
          if [ -z "$STATUS_TOKEN" ]; then
            echo "Missing STATUS_TOKEN; cannot publish status." >&2
            exit 1
          fi
          START_TIME="${TEST_STARTED_AT:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}"
          COMPLETE_TIME="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          PAYLOAD=$(jq -n \
            --arg name "Test Coverage / test" \
            --arg sha "$RELEASE_SHA" \
            --arg status "completed" \
            --arg conclusion "success" \
            --arg url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg start "$START_TIME" \
            --arg end "$COMPLETE_TIME" \
            '{
              name: $name,
              head_sha: $sha,
              status: $status,
              conclusion: $conclusion,
              details_url: $url,
              started_at: $start,
              completed_at: $end,
              output: {
                title: "Test Coverage",
                summary: "npm run test:ci executed inside the Release workflow to satisfy branch protection."
              }
            }')
          curl -sS -X POST \
            -H "Authorization: token ${STATUS_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/check-runs \
            -d "$PAYLOAD" >/dev/null

      - name: Fast-forward main with release commit
        env:
          RELEASE_BRANCH: ${{ env.RELEASE_BRANCH }}
        run: |
          set -euo pipefail
          if [ -z "$RELEASE_BRANCH" ]; then
            echo "Release branch name missing." >&2
            exit 1
          fi
          git checkout main
          git pull origin main
          git merge --ff-only "$RELEASE_BRANCH"
          git push origin main

      - name: Delete temporary release branch
        if: always()
        env:
          RELEASE_BRANCH: ${{ env.RELEASE_BRANCH }}
        run: |
          if [ -n "$RELEASE_BRANCH" ]; then
            git push origin --delete "$RELEASE_BRANCH" || true
          fi
