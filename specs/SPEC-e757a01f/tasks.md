# タスク: C# LSP統合機能

**機能ID**: `SPEC-e757a01f` | **ステータス**: 部分完了（軽量スニペット編集は未着手）

## 実装状況

### 完了済み機能

- [x] US-1: シンボル検索
- [x] US-2: 参照検索
- [x] US-3: 構造化編集
- [x] US-4: リネーム
- [x] US-5: シンボル定義取得
- [x] US-6: コードインデックス管理

### 新規機能（US-7: 軽量スニペット編集）

#### Phase 0: リサーチ

- [ ] R-001: Roslyn LSP側で任意テキスト編集後に即時構文診断を得る最適なリクエストを特定
- [ ] R-002: LspRpcClientに複数テキストEditを適用するAPIの存在確認と拡張方法検討
- [ ] R-003: 既存 script_search のレスポンス構造確認、アンカー解像度への再利用可能性検証
- [ ] R-004: フォーマッタ（dotnet-format等）呼び出しの必要性評価

#### Phase 1: 設計

- [ ] D-001: JSONスキーマ定義（edits配列、anchor構造、operation型）
- [ ] D-002: アンカー解決アルゴリズム設計（一意性検証、候補返却）
- [ ] D-003: 括弧整合性検証パイプライン設計
- [ ] D-004: エラーハンドリング仕様（ロールバック、フォールバック案内）
- [ ] D-005: レスポンス形式設計（status/reason/snippet）

#### Phase 2: 実装

**Setup**
- [ ] S-001: ScriptEditSnippetToolHandler.js クラス作成
- [ ] S-002: ハンドラ登録（src/handlers/index.js）
- [ ] S-003: MCPツール定義（inputSchema）

**Core: アンカー解決**
- [ ] C-001: アンカーマッチング関数実装（before/target/after）
- [ ] C-002: 候補検索ロジック実装（script_search統合）
- [ ] C-003: 一意性検証と衝突検出
- [ ] C-004: 80文字制限チェック

**Core: 編集適用**
- [ ] C-005: 編集操作適用（delete/replace/insert）
- [ ] C-006: バッチ編集パイプライン（最大10箇所）
- [ ] C-007: 一時バッファ管理

**Core: 構文検証**
- [ ] C-008: LSP diagnostics取得
- [ ] C-009: 括弧・波括弧整合性チェック
- [ ] C-010: ロールバック機構

**Core: レスポンス生成**
- [ ] C-011: status/reason生成（applied/skipped/error）
- [ ] C-012: 編集前後スニペット抽出
- [ ] C-013: ハッシュ値生成（重複適用防止）

**Integration**
- [ ] I-001: Previewモード実装
- [ ] I-002: Applyモード実装（WorkspaceEdit送信）
- [ ] I-003: エラーメッセージ日本語化
- [ ] I-004: トークン制限対応（1000文字以内）

**Polish**
- [ ] P-001: 空ブロック検出
- [ ] P-002: フォーマット破綻検出
- [ ] P-003: コメントアウト検出
- [ ] P-004: ファイルロック検出

#### Phase 3: テスト

**Unit Tests**
- [ ] T-001: アンカーマッチングテスト
- [ ] T-002: 80文字制限テスト
- [ ] T-003: 括弧整合性検証テスト
- [ ] T-004: エラーハンドリングテスト

**Integration Tests**
- [ ] T-005: ガード削除テスト（US-7.1）
- [ ] T-006: 条件式置換テスト（US-7.2）
- [ ] T-007: ログ挿入テスト（US-7.3）
- [ ] T-008: バッチ編集テスト（10箇所）
- [ ] T-009: プレビューモードテスト
- [ ] T-010: ロールバックテスト

**E2E Tests**
- [ ] T-011: 実プロジェクトでのガード削除
- [ ] T-012: 複数箇所同時編集
- [ ] T-013: エラーリカバリ検証

#### Phase 4: ドキュメント

- [ ] DOC-001: CLAUDE.md更新（script_edit_snippet使用ガイドライン）
- [ ] DOC-002: 使用例追加
- [ ] DOC-003: トラブルシューティング追加

## 参考

実装詳細については `spec.md` および `plan.md` を参照してください。

---
*本ドキュメントは実装完了後に作成され、軽量スニペット編集タスクの追加に伴い更新されました（2025-10-24）*
