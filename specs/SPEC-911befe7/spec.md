# 機能仕様書: マルチインスタンス安全切替 CLI

**機能ID**: `SPEC-911befe7`
**作成日**: 2025-12-04
**ステータス**: 下書き
**入力**: ユーザー説明: "マルチインスタンス安全切替 CLI (list-instances / set-active)"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 接続先を見える化して誤接続を防ぎたい (優先度: P1)
複数の Unity プロジェクトを同時に開いている状態で、どこに接続しているかを常に把握したい。`list-instances` で一覧とアクティブ印が見えれば安心できる。

**この優先度の理由**: 誤送信が事故につながるため最重要。

**独立テスト**: 2 インスタンス起動後に list して両方表示・アクティブ印が付けば価値成立。

**受け入れシナリオ**:
1. **前提** 2 つの Unity が 6400/6401 で待受、**実行** `list-instances --ports 6400,6401`, **結果** 両方が status/up として表示され、アクティブ印が現在の接続先に付く。
2. **前提** 6401 が停止、**実行** 同コマンド、**結果** 6401 が down 表示になりアクティブにはならない。

---

### ユーザーストーリー2 - 明示的に接続先を切り替えたい (優先度: P1)
`set-active <id>` で以後のコマンド送信先を確実に切替えたい。切替結果は即時に表示されたい。

**この優先度の理由**: 誤送信を防ぎ再現性を保つため。

**独立テスト**: set-active で A→B に切替後、次の ping が B で成功すれば価値成立。

**受け入れシナリオ**:
1. **前提** アクティブ A、**実行** `set-active localhost:6401`, **結果** アクティブが B に更新され、確認 ping が成功する。
2. **前提** 存在しない ID を指定、**実行** `set-active localhost:6500`, **結果** エラーと list 再実行のガイドが返る。

---

### ユーザーストーリー3 - ダウン先への誤送信を防ぎたい (優先度: P2)
選択先が落ちている場合は短時間で失敗し、別インスタンスを選ぶよう促してほしい。

**独立テスト**: 落ちたポートを set-active したとき 1 秒以内に疎通不可エラーが返れば価値成立。

**受け入れシナリオ**:
1. **前提** 指定ポートがダウン、**実行** set-active、**結果** "unreachable" エラーと代替候補ガイド。
2. **前提** 連続で set-active が走る、**実行** A→B→A を連続実行、**結果** 最後の指定が確定し履歴に残る。

### エッジケース
- zombie プロセス (ソケット開放済み) はヘルスチェックで除外する。
- ポートリストに重複がある場合は一意化して警告を出す。
- set-active 実行中に別コマンドが送られた場合は、切替完了後のアクティブ先に送る。

## 要件 *(必須)*

### 機能要件
- **FR-001**: `list-instances` コマンドでホスト/ポート、稼働状態、アクティブ印を表示し、JSON 出力も提供する。
- **FR-002**: `set-active <id>` で以後のコマンド送信先を切替え、結果を即座に返す。
- **FR-003**: 疎通不可のインスタンスを指定した場合、安全に失敗し再選択ガイドを返す（タイムアウト ≤1s）。
- **FR-004**: 連続 set-active の場合でも最終指定が確実に反映され、履歴ログに残る。
- **FR-005**: エラーメッセージは日本語/英語いずれかで人間が理解できる形式で返す。

### 主要エンティティ
- **InstanceEntry**: host, port, status(up/down), lastCheckedAt, active。
- **InstanceRegistry**: entries[], activeId, setActive(id), markStatus(id,status)。

## スコープ外
- 自動フェイルオーバーやブロードキャスト送信。

## 技術制約
- Unity 2020.3 LTS 以降を対象。
- ping タイムアウトは 1 秒以内にする。

## 前提条件
- MCP クライアントが list/set-active コマンドを呼び出せる。

## 依存関係
- 既存ポート設定/接続管理ロジック。

## 成功基準
1. 2 インスタンス環境で 5 回連続の set-active 切替が全て正しい先に届き誤送信ゼロ。
2. 停止インスタンス指定時、1 秒以内にエラーとガイドを返す。
3. zombie/停止インスタンスが list に残らない（チェック後除外または down 表示）。
