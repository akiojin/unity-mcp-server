# 機能仕様書: 軽量スニペット編集ツール

**機能ID**: `SPEC-4f7a596b`
**作成日**: 2025-10-23
**ステータス**: 草案
**入力**: 「edit_structuredをLLMが利用しにくい。1-2行のnullチェック削除など小規模編集が複数箇所に分散している。メソッド全体を書き直さずに済む簡易ツールが必要。まず要件をまとめてほしい。」

## 背景と目的
- LLMはUnityプロジェクト内のC#コードを自動編集するが、既存の`edit_structured`はメソッド全体の置換やクラス単位の追加に最適化されている。
- Unityワークフローでは、Safety Guardや例外処理のような軽微なガード削除・条件変更が頻出し、1回の整形で複数箇所に分散するケースが多い。
- 過去に行指向の編集を許容した際、括弧・波括弧の対応が崩れてビルド不能になるケースが多発したため、`edit_structured`のみを使用する方針に切り替えた経緯がある。
- 行単位の直接編集はこれまで安全性の観点から禁止されており、再導入する場合は構造的な信頼性と検証ステップが必要。
- 本機能は「小さな断片編集」を高精度かつ低負荷で実現し、LLMエージェントが高頻度に呼び出せる安全なツールを提供することを目的とする。

## ビジネス価値
- **開発効率向上**: メソッド全体を置換せずに済むため差分調整が高速化し、フィードバックループを短縮。
- **リスク低減**: 小規模変更を局所化することで不要な副作用を抑制し、レビュー容易性を高める。
- **LLM活用促進**: 使い勝手が高いツールを提供して、エージェント実行率を向上させる。

## スコープ
- **対象**: `Assets/` および `Packages/` 配下のC#ファイルに対する短いステートメント/式/ガードの挿入・置換・削除。
- **非対象**: 大規模リファクタリング、複数ファイル横断での意味解析、テンプレート生成、メソッド/クラス全体の再構成。
- **成果物**: 新規MCPツール（仮称: `edit_snippet`）の要件定義。

## ユーザーシナリオ＆テスト

### 主要ユーザーストーリー

#### US-1: ガード削除
**AS** LLMエージェント  
**I WANT** 例外的なnullチェックを安全に削除したい  
**SO THAT** 本質的なロジックを変更せずに防御的コードを簡素化できる  

**受け入れ基準**:
- 同一メソッド内で3箇所までの`if (foo == null) { return; }`形式のガードを1回のツール呼び出しで削除できる。
- 削除対象が見つからない場合は適用せず、整合性チェック付きの警告を返す。
- 編集後に残る空行や余分なセミコロンを自動的に整理する。

#### US-2: 条件式の最小変更
**AS** LLMエージェント  
**I WANT** 条件式の一部を数文字単位で置換したい  
**SO THAT** 分岐条件のバグ修正を迅速に行える  

**受け入れ基準**:
- 比較演算子や呼び出し名など部分一致指定で最大5箇所まで置換できる。
- 置換対象の周辺コンテキスト（前後2行）を指定して誤適用を防ぐ。
- 適用結果を1件ずつ詳細なステータスで返し、成功/スキップ理由を区別できる。

#### US-3: ログ挿入
**AS** Unity開発者  
**I WANT** 既存メソッド内の早期return直前にログを挿入したい  
**SO THAT** デバッグ用のログ追加を素早く行える  

**受け入れ基準**:
- `return`文など特定キーワードをアンカーにして直前へ1行挿入できる。
- 既に同等のログが存在する場合は重複を検出し、挿入を行わない。
- 1回の呼び出しで同一ファイル内の複数`return`に同じコードを挿入できる。

### エッジケース
- 編集対象がコメントアウトされている場合は無視し、警告を返す。
- 編集後にコードフォーマッタが破綻する恐れがある場合、適用を拒否し改善案を提示する。
- ファイルが読み取り専用またはロックされている場合は失敗理由を明示する。

## 要件

### 機能要件
- **FR-001**: ツールは編集対象ファイルと複数編集指示を一括で受け取り、最大10箇所の局所編集を1回の呼び出しで処理できる。
- **FR-002**: 各編集指示は「操作タイプ（削除/置換/挿入）」「アンカー情報（前後のコードスニペットまたはシンボルパス）」「編集内容」を必須項目として定義する。
- **FR-003**: ツールはアンカー検証を行い、対象が一意に決定できない場合は失敗し、衝突箇所の候補一覧を返す。
- **FR-004**: ツールはアンカー一致後の差分が80文字以内であることを保証し、この上限を超える指示は拒否する。
- **FR-005**: ツールは編集結果をapplyする前にミニマルな構文チェックを行い、括弧・波括弧の不整合が発生した場合は全体をロールバックしてエラーを返す。
- **FR-006**: ツールは各編集について`status`（applied/skipped/error）と`reason`、編集前後の短いスニペットを返却する。
- **FR-007**: ツールは`preview=true`指定時に副作用を発生させず、全候補結果と潜在的なフォーマット変更を提示する。
- **FR-008**: ツールは`Assets/`または`Packages/`外のファイルを拒否し、統一したエラーメッセージを返す。
- **FR-009**: ツールは`edit_structured`との併用を想定し、同一リクエスト内で編集結果のハッシュを返して重複適用を防ぐ。
- **FR-010**: ツールは編集後に空になったブロック（例: 空の`if`文）を検出し、警告として通知する。

### 非機能要件
- **NFR-001**: 1回の呼び出しで最大10箇所編集してもレスポンス時間は2秒以内（常駐LSP利用時）。
- **NFR-002**: エラーメッセージは200文字以内、日本語で返却し、LLMが直接ユーザーへ提示できる。
- **NFR-003**: 成功応答のテキストフィールドは1000文字以内に抑制し、トークンコストを最小化する。
- **NFR-004**: 競合発生時は編集箇所を自動的にスキップし、他の編集は継続する（ベストエフォート適用）。
- **NFR-005**: 前提としてNodeサーバー常駐LSPが利用可能でなければならない。LSP未起動時は自動起動を試み、失敗時に詳細なトラブルシュートを返す。

### 依存関係と前提
- 既存のコードインデックスおよび構文解析機能（C# LSP）を利用する。
- ツールは`read`や`get_symbols`と組み合わせて使用されることを前提とする。
- LLMクライアントはアンカー情報を生成するために対象コードを事前に取得できる。

### 成功指標
- 公開後1週間以内にLLMのC#編集リクエストの70%以上で当該ツールが選択される。
- `edit_structured`の呼び出し回数のうち、メソッド全体置換目的を除くケースが80%減少する。
- 追加レビューで差し戻される小規模編集の件数が現状比30%削減される。

## レビューチェックリスト
- [x] ユーザー価値と目的が明確に記述されている
- [x] 技術的な実装詳細を記載していない
- [x] 要件がテスト可能な形で定義されている
- [x] スコープと非スコープが明確に区別されている
- [ ] 依存関係の検証が完了している（今後の計画作業で確認）
- [ ] テスト観点の最終レビューが完了している（実装フェーズで更新予定）
