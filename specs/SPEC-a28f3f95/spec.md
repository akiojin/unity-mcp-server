# 機能仕様書: HTTP/プロキシ対応とテレメトリ透明性

**機能ID**: `SPEC-a28f3f95`
**作成日**: 2025-12-04
**ステータス**: 下書き
**入力**: ユーザー説明: "HTTP/プロキシ対応、テレメトリ明示"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - HTTPのみ許可された環境で接続したい (優先度: P1)

企業ネットワークで TCP/stdio が遮断されていても、HTTP/JSON-RPC で Unity MCP サーバーに接続したい。追加ツールなしで `--http` 起動し、ヘルスチェックで即確認したい。

**この優先度の理由**: ネットワーク制約で導入可否が左右されるため最重要。

**独立テスト**: `npx ... --http 6401` で起動し `/healthz` が 200 を返すことを確認すれば価値成立。

**受け入れシナリオ**:

1. **前提** TCP/stdio が閉じた社内ネットワーク、**実行** HTTP モードで起動しヘルスチェック実行、**結果** 200 応答と接続手順が得られクライアント接続が成功する。
2. **前提** HTTP ポートが占有されている、**実行** 同ポート指定で起動、**結果** 起動が失敗し代替ポート候補と再実行例が表示される。

---

### ユーザーストーリー2 - テレメトリ送信を明示的に管理したい (優先度: P2)

セキュリティポリシーの厳しい環境で、デフォルトは送信なし、必要なら明示的に許可する形にしたい。設定値と送信先がログと README で確認でき、無効化状態を起動時に表示してほしい。

**この優先度の理由**: 事前審査のボトルネックを解消し、導入を早める。

**独立テスト**: テレメトリ無効で起動し、ネットワークキャプチャで外向き通信 0 件を確認すれば価値成立。

**受け入れシナリオ**:

1. **前提** テレメトリ禁止ポリシー、**実行** デフォルト設定で起動、**結果** 起動ログに「テレメトリ送信なし」が表示され、送信が発生しない。
2. **前提** テレメトリを明示的に許可したい、**実行** 環境変数を設定して起動、**結果** 送信先と収集項目がログに表示され、オプトアウト方法も併記される。

### エッジケース

- HTTP/stdio の両方を有効にした際にプロセスを二重起動しない（単一プロセスで複数チャネルを扱うか、拒否する）。
- 企業プロキシ環境で `HTTP_PROXY` などが未設定の場合、起動時にヒントを表示する。
- ヘルスチェックだけが通り実処理が失敗する場合、HTTP レスポンスに詳細なエラー理由を含める。
- テレメトリ無効時に依存ライブラリが自動送信を試みた場合、起動を失敗させ原因を明示する。

## 要件 *(必須)*

### 機能要件

- **FR-001**: サーバー起動時に HTTP トランスポートを有効化でき、標準ヘルスチェックエンドポイントを提供する。
- **FR-002**: stdio/TCP と HTTP を排他的または同時に有効化でき、起動ログに有効チャネルとポートを明示する。
- **FR-003**: HTTP ポート競合時は起動をブロックし、代替ポート候補と再実行例を提示する。
- **FR-004**: テレメトリ送信のデフォルトを「送信なし」とし、送信先・収集項目・オプトアウト方法を README と起動ログで開示する。
- **FR-005**: テレメトリを有効にした場合は起動時に送信先をログ出力し、無効時は外向き通信が 0 であることを確認できる。
- **FR-006**: HTTP モード有効時も既存 CLI/クライアント互換性を維持し、API 仕様を README に追記する。
- **FR-007**: エラー時のレスポンスは人間可読（日本語/英語どちらか）で返す。

### 主要エンティティ

- **接続チャネル設定**: stdio/TCP/HTTP の有効フラグ、ポート、ヘルスチェックパス。
- **テレメトリ設定**: 送信有無、送信先、収集項目、オプトアウト方法。

## スコープ外

- HTTP 認証や VPN/プロキシ自動検出。
- 送信データの分析基盤構築。

## 技術制約

- Unity 2020.3 LTS 以降で動作すること。
- HTTP モード追加によって既存 stdio/TCP モードを破壊しないこと。
- テレメトリ無効時に外部通信を行わないこと（依存ライブラリも含む）。

## 前提条件

- MCP クライアントが HTTP もしくは stdio/TCP のいずれかをサポートしている。
- HTTP 用ポートがローカルで開放できる権限がある。

## 依存関係

- 既存の MCP サーバー起動フロー（CLI/Node）。
- 既存ポート設定管理ロジック。

## 成功基準

1. HTTP モード起動時のヘルスチェック成功率が社内ネットワーク検証 3 回中 3 回で 100%。
2. テレメトリ無効設定下の外向き通信がネットワークキャプチャで 0 件。
3. ポート競合時に 100% 再実行ガイドが表示され、重複起動が発生しない。
