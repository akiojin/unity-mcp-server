# 機能仕様書: コンソール管理機能

**機能ID**: `SPEC-2e6d9a3b`
**作成日**: 2025-10-17
**ステータス**: 確定
**入力**: Unity Consoleのログ読み取り、クリア、フィルタリング、自動クリア設定

## 実行フロー (main)
```
1. 入力からコンソール操作要件を解析
   → 操作タイプ（読み取り/クリア/設定変更）の特定
2. コンソールログの読み取り（読み取り操作時）
   → フィルタ条件（ログタイプ、テキスト、時間範囲）の適用
   → 件数、ソート順、出力形式の指定
   → グループ化オプション（タイプ/ファイル/時間別）
3. コンソールのクリア（クリア操作時）
   → 保護オプション（エラー/警告を保持）の適用
   → 自動クリア設定の更新（Play/Build/Recompile時）
4. ログのフォーマット
   → 出力形式（detailed/compact/json/plain）の適用
   → スタックトレースの含有制御
5. 結果の返却
   → フィルタ/グループ化されたログ情報
6. 戻り値: SUCCESS（ログ情報またはクリア結果）
```

---

## ⚡ クイックガイドライン
- ✅ デバッグログの効率的な管理とAIエージェントによるログ分析の必要性に焦点
- ❌ 内部的なUnityのログシステムやコンソールウィンドウの実装詳細は避ける
- 👥 ゲーム開発者・QAエンジニア・AIエージェント向けに記述

---

## ユーザーシナリオ＆テスト

### 主要ユーザーストーリー
開発者として、デバッグ情報を効率的に確認するために、コンソールログをプログラムで読み取り・フィルタリングしたい。AIエージェントとして、エラーログを分析し、問題解決の提案をしたい。

### 受け入れシナリオ
1. **前提** コンソールにログが表示されている、**実行** 最新100件のログ取得、**結果** 最新100件のログが返される
2. **前提** エラーのみ確認したい、**実行** ログタイプでフィルタ（Error）、**結果** エラーログのみが返される
3. **前提** 特定の文字列を含むログを探したい、**実行** テキストフィルタを適用、**結果** マッチするログのみが返される
4. **前提** 特定時間以降のログを確認したい、**実行** 時間範囲フィルタを適用、**結果** 指定時間以降のログが返される
5. **前提** ログをタイプ別にグループ化したい、**実行** groupBy=typeで読み取り、**結果** タイプ別にグループ化されたログが返される
6. **前提** コンソールをクリアしたい、**実行** クリア要求、**結果** 全ログがクリアされる
7. **前提** エラーは残してクリアしたい、**実行** preserveErrors=trueでクリア、**結果** エラー以外がクリアされる
8. **前提** Play時に自動クリアしたい、**実行** clearOnPlay=trueで設定、**結果** Play開始時に自動クリアされる

### エッジケース
- ログが存在しない場合、何が返されるか? → 空の配列とログ数0を返す
- フィルタ条件にマッチするログがない場合、どう処理するか? → 空の結果とフィルタ条件の説明を返す
- スタックトレースを含むと大量のデータになる場合、どうなるか? → 最大件数で制限し、truncatedフラグを返す
- 自動クリア設定が競合する場合（保護とクリアの両方）、どう処理するか? → 保護が優先され、警告を返す
- コンソールが1000件以上のログを含む場合、パフォーマンスは? → 最大1000件に制限し、警告を返す

## 要件

### 機能要件
- **FR-001**: ユーザーはコンソールログを読み取ることができる必要がある
- **FR-002**: システムは取得するログの最大件数を指定できる必要がある（1-1000、デフォルト100）
- **FR-003**: ユーザーはログタイプ（Info/Warning/Error/All）でフィルタリングできる必要がある
- **FR-004**: ユーザーはテキスト検索（大文字小文字を区別しない）でフィルタリングできる必要がある
- **FR-005**: ユーザーは時間範囲（sinceTimestamp/untilTimestamp）でフィルタリングできる必要がある
- **FR-006**: システムはログのソート順（newest/oldest）を指定できる必要がある
- **FR-007**: システムは4種類の出力形式（detailed/compact/json/plain）をサポートする必要がある
- **FR-008**: ユーザーはスタックトレースの含有を制御できる必要がある
- **FR-009**: ユーザーはログをグループ化できる必要がある（none/type/file/time別）
- **FR-010**: ユーザーはコンソールをクリアできる必要がある
- **FR-011**: システムはクリア時にエラーを保護するオプションをサポートする必要がある
- **FR-012**: システムはクリア時に警告を保護するオプションをサポートする必要がある
- **FR-013**: ユーザーはPlay時の自動クリアを設定できる必要がある
- **FR-014**: ユーザーはBuild時の自動クリアを設定できる必要がある
- **FR-015**: ユーザーはRecompile時の自動クリアを設定できる必要がある

### 非機能要件
- **NFR-001**: ログ読み取りは2秒以内に完了する必要がある（1000件以下の場合）
- **NFR-002**: ログフィルタリングは1秒以内に完了する必要がある
- **NFR-003**: コンソールクリアは500ms以内に完了する必要がある
- **NFR-004**: グループ化処理は3秒以内に完了する必要がある（1000件以下の場合）
- **NFR-005**: 自動クリア設定の更新は100ms以内に完了する必要がある

### 主要エンティティ
- **ConsoleLog**: ログメッセージ、タイプ、タイムスタンプ、ファイル、行番号、スタックトレースを含むログ情報
- **LogFilter**: ログタイプ、テキスト、時間範囲を含むフィルタ条件
- **LogReadOptions**: 件数、ソート順、出力形式、グループ化、スタックトレース含有を含む読み取りオプション
- **ClearOptions**: エラー保護、警告保護、自動クリア設定を含むクリアオプション
- **LogGroup**: グループ化キー、ログリスト、カウントを含むグループ情報

---

## レビュー＆受け入れチェックリスト

### コンテンツ品質
- [x] 実装詳細なし（言語、フレームワーク、API）
- [x] ユーザー価値とビジネスニーズに焦点
- [x] 非技術関係者向けに記述
- [x] すべての必須セクション完成

### 要件完全性
- [x] [要明確化]マーカーが残っていない
- [x] 要件はテスト可能で曖昧さがない
- [x] 成功基準は測定可能
- [x] スコープが明確に境界付けられている
- [x] 依存関係と前提条件が識別されている

---

## 実行ステータス

- [x] ユーザー説明を解析済み
- [x] 主要概念を抽出済み
- [x] 曖昧さをマーク済み
- [x] ユーザーシナリオを定義済み
- [x] 要件を生成済み
- [x] エンティティを識別済み
- [x] レビューチェックリスト合格

---

## 参考実装

### 実装ファイル
- `/mnt/e/unity-mcp-server/mcp-server/src/handlers/console/ReadConsoleToolHandler.js`
- `/mnt/e/unity-mcp-server/mcp-server/src/handlers/console/ClearConsoleToolHandler.js`
- `UnityMCPServer/Packages/unity-mcp-server/Editor/Handlers/ConsoleManagementHandler.cs`

### 技術詳細
- UnityEditor.LogEntriesによるログ取得
- Reflectionによるコンソール内部状態へのアクセス
- ISO 8601形式でのタイムスタンプ処理
- 出力形式のカスタマイズとグループ化処理
- 自動クリア設定のEditorPrefs保存
