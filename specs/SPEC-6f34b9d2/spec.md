# 機能仕様書: Unity TCP セッション識別と再接続安全化

**機能ID**: `SPEC-6f34b9d2`  
**作成日**: 2025-12-12  
**ステータス**: 下書き  
**入力**: issue #222（再起動/リロード後の不安定）、現行 UnityConnection の pending フォールバック挙動

## 背景

Unity Editor 側の TCP サーバはコンパイル/ドメインリロードで接続が切り替わりやすい。Node 側は再接続後も古いソケット由来の遅延応答が届く可能性があり、現行実装では **id 不一致/欠落時に先頭 pending を解決するフォールバック**があるため、誤応答が紐付く危険がある。

## 目的

- 接続ごとに **セッションID** を確立し、**同一セッションの応答のみを有効**とすることで、再接続後の誤解決を防ぐ。

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 再接続後に古い応答が混入しても安全でありたい (優先度: P1)
Unity が再起動/ドメインリロードした直後に古いレスポンスが遅れて届いても、Node 側はそれを無視して誤ったコマンド完了を起こさないでほしい。

**独立テスト**: セッションAで送ったコマンドの応答がセッションB確立後に届いても、pending が解決されず破棄されれば価値成立。

**受け入れシナリオ**:
1. **前提** セッションAで command1 を送信→接続切断→セッションBで再接続、**実行** セッションAの response(command1) を受信、**結果** Node は無視し pending を解決しない。
2. **前提** セッションBで command2 を送信、**実行** セッションBの response(command2) を受信、**結果** 正常に pending が解決される。

---

### ユーザーストーリー2 - 旧バージョンUnityでも壊れないでほしい (優先度: P1)
Unity パッケージが旧版で sessionId を返さない場合でも、通常のコマンドは従来通り動作してほしい。

**独立テスト**: sessionId 無しレスポンスでも id が一致していれば解決される。

## 要件 *(必須)*

### 機能要件
- **FR-001**: Node 側は TCP 接続確立ごとに `sessionId` を生成し、全ての command に付与する。
- **FR-002**: Unity 側は command に `sessionId` が含まれる場合、同じ値を response に付与する。
- **FR-003**: Node 側は response の `sessionId` が現在のセッションと一致しない場合、**pending を解決せず破棄**する。
- **FR-004**: response が `sessionId` を持たない場合は **id 一致のみで解決**し、id 不一致/欠落時のフォールバック解決は行わない（pending が1件のみ等の例外は設けない）。

### 非機能要件
- **NFR-001**: セッション付与/検証により通常コマンドの互換性を壊さない。
- **NFR-002**: 追加フィールドは軽量（32hex 程度）で、通信量増加は無視できる範囲。

### データモデル
- `sessionId`: 32文字 hex（GUIDハイフン無し相当）

## スコープ外
- セッションハンドシェイクのバージョン交渉（protocolVersion）は後続(P2)。
