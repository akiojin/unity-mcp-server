# 機能仕様書: PRベースの自動マージ機能

**機能ID**: `SPEC-bf408776`
**作成日**: 2025-10-29
**ステータス**: 下書き
**入力**: ユーザー説明: "PRベースの自動マージ機能 - featureブランチの開発完了時に、GitHub Pull Requestを自動作成し、CI/CDチェック成功後に自動的にmainブランチへマージする機能"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 自動PR作成 (優先度: P1)

開発者がfeatureブランチでの作業を完了したとき、手動でGitHub PR作成画面を開いてフォームを入力する代わりに、finish-feature.shスクリプトを実行するだけで、SPEC情報を含む適切に構成されたPRが自動的に作成される。

**この優先度の理由**: PRの作成は開発フローの中核であり、この自動化なしでは後続のRequiredチェックと自動マージが機能しません。最も基本的な価値提供要素です。

**独立テスト**: finish-feature.shスクリプトを実行し、GitHub上にPRが正しく作成されたことを確認することで完全にテストできます。

**受け入れシナリオ**:

1. **前提** 開発者がfeature/SPEC-xxxxブランチで作業完了、**実行** finish-feature.shを実行、**結果** GitHub上にPRが自動作成され、タイトルがspec.mdから取得される
2. **前提** SPECディレクトリにspec.mdが存在、**実行** finish-feature.shを実行、**結果** PRボディにSPEC情報（機能ID、説明、変更サマリー）が含まれる
3. **前提** --draftオプション付きで実行、**実行** finish-feature.sh --draftを実行、**結果** ドラフトPRとして作成され、自動マージ対象外となる

---

### ユーザーストーリー2 - Requiredチェック監視 (優先度: P2)

PRが作成されたとき、プロジェクトマネージャーはGitHubブランチ保護でRequiredとして指定されたチェック結果だけを根拠に自動マージ可否を判断できる。システムは新たにテストやビルドを実行せず、GitHubが報告するRequiredチェックのステータスを監視し、開発者へ即座にフィードバックを返す。

**この優先度の理由**: 必須チェックに判断を集約することで、不要なテスト実行を排除しつつ、組織で合意された品質ゲートを確実に守れるため。P1の自動PR作成の後段にある最小限の審査ステップとして不可欠です。

**独立テスト**: Requiredチェックを意図的に失敗させたPRを作成し、自動マージが保留されることを確認する。Requiredチェックを成功させたPRでは自動マージ準備完了が表示されることを確認する。

**受け入れシナリオ**:

1. **前提** Requiredチェックの1つが失敗、**実行** PRを作成、**結果** GitHubステータスが失敗となり、自動マージは保留され理由がPRに表示される
2. **前提** Requiredチェックが進行中、**実行** PRを作成、**結果** GitHubステータスがPendingのままとなり、自動マージもPendingで待機する
3. **前提** Requiredチェックのみが成功し、任意チェックが失敗、**実行** PRを作成、**結果** 自動マージ準備完了が表示され、任意チェックはブロックしない
4. **前提** Requiredチェックがすべて成功、**実行** PRを作成、**結果** 自動マージ準備完了が表示される

---

### ユーザーストーリー3 - 自動マージ実行 (優先度: P3)

すべてのRequiredチェックが成功したとき、開発者が手動でマージボタンを押すことなく、システムが自動的にmainブランチへマージし、マージコミット形式で履歴を保持する。

**この優先度の理由**: 自動マージは最終段階の自動化であり、P1とP2が完成して初めて価値を発揮します。承認待ちやマージ忘れを防ぐ追加の利便性を提供します。

**独立テスト**: Requiredチェックがすべて成功するPRを作成し、一定時間後にmainブランチに自動的にマージされ、マージコミットが作成されることで検証できます。

**受け入れシナリオ**:

1. **前提** PRが作成され、すべてのRequiredチェックが成功、**実行** チェック完了後待機、**結果** PRが自動的にmainブランチへマージされる
2. **前提** 自動マージ実行時にコンフリクトが発生、**実行** マージ試行、**結果** マージが中断され、手動解決を促すコメントがPRに追加される
3. **前提** ドラフトPRが作成されている、**実行** Requiredチェックがすべて成功、**結果** 自動マージはスキップされ、ドラフト解除待ちのステータスが表示される
4. **前提** 自動マージが成功、**実行** マージ履歴確認、**結果** --no-ffオプションでマージコミットが作成され、履歴が保持されている

---

### エッジケース

- GitHub CLIが認証されていない場合、finish-feature.shはエラーメッセージを表示し、`gh auth login`を促す
- SPECディレクトリにspec.mdが存在しない場合、PRタイトルはブランチ名から生成される
- Requiredチェック実行中にmainブランチが更新された場合、自動マージ前に最新のmainとの同期を試みる
- 複数のPRが同時に自動マージ待ちの場合、GitHub Actionsのキューで順次処理される
- ネットワーク障害やGitHub API障害時、自動マージは再試行され、失敗時は開発者に通知される

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは finish-feature.sh 実行時に、自動的にGitHub PRを作成する必要がある
- **FR-002**: システムは spec.md から機能タイトルを読み取り、PRタイトルに使用する必要がある
- **FR-003**: システムは PRボディに SPEC情報（機能ID、説明、変更サマリー）を含める必要がある
- **FR-004**: システムは GitHub API を用いて対象ブランチのRequiredチェックステータスを取得する必要がある
- **FR-005**: システムは Requiredチェックが全て `success` になるまで自動マージを開始してはならない
- **FR-006**: システムは Requiredに指定されていないチェック結果を理由に自動マージを停止してはならない
- **FR-007**: システムは Requiredチェックが失敗またはタイムアウトした場合、PRに理由をコメントし開発者へ通知する必要がある
- **FR-008**: システムは Requiredチェックが全て成功した場合、自動的にmainブランチへマージする必要がある
- **FR-009**: システムは マージ時に --no-ff オプションを使用し、マージコミット形式で履歴を保持する必要がある
- **FR-010**: システムは ドラフトPRを自動マージ対象外とする必要がある
- **FR-011**: システムは マージ失敗時（コンフリクトなど）にPRへコメントを追加し、開発者に通知する必要がある
- **FR-012**: ユーザーは --draft オプションでドラフトPRを作成できる必要がある
- **FR-013**: システムは main と develop ブランチへのPRに対してのみ自動マージを実行する必要がある

### 主要エンティティ

- **SPEC**: 機能仕様書。機能ID（SPEC-UUID8桁）、タイトル、説明、タスクリストを含む
- **Pull Request**: GitHub上のマージリクエスト。タイトル、ボディ、ステータス（draft/open/merged）、チェック結果を持つ
- **Requiredチェック**: GitHubブランチ保護でRequiredに設定されたステータスチェック。成功・失敗・Pendingなどの結果を自動マージ判定に利用
- **マージコミット**: 自動マージ時に作成されるGitコミット。--no-ffオプションで履歴を保持

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- コードレビュー承認プロセス（現時点ではRequiredチェックのみで自動マージ）
- Slack/Teams等への通知連携
- マージ前の自動コンフリクト解決
- カスタムチェックルールの動的追加
- マージ後の自動タグ付け/リリース作成

---

## 技術制約 *(該当する場合)*

- GitHub CLI（gh）がインストール済みで認証されている必要がある
- GitHub Actionsの実行権限とシークレット設定が必要
- Git 2.15以降（worktree機能サポート）が必要
- Bash 4.0以降（スクリプト実行環境）が必要

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- プロジェクトがGitHubでホストされている
- 既存のfinish-feature.shスクリプトが存在する
- SPEC駆動開発フロー（spec.md, tasks.md）が採用されている
- GitHubブランチ保護でRequiredチェックが設定されている

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- **GitHub CLI（gh）**: PR作成・管理に使用
- **GitHub Actions / Required Status Checks**: ブランチ保護で定義されたRequiredチェック結果を提供
- **GitHubブランチ保護設定**: Requiredチェックと自動マージに必要なルールを定義
- **@akiojin/claude-worktree**: 設計思想とワークフロー参考元

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. 開発者がPR作成にかける時間が平均5分から30秒以内に短縮される
2. Requiredチェックが未完了のまま自動マージされるケースがゼロになる
3. チェック成功後、5分以内に自動マージが完了する
4. マージ失敗時、10分以内に開発者へフィードバックが提供される
5. ドラフトPRが誤って自動マージされるケースがゼロになる
6. 自動マージされたコミットの100%がマージコミット形式（--no-ff）で履歴が保持される
7. コンフリクト発生時、100%のケースで適切なエラーメッセージがPRに表示される

---

## ⚡ クイックガイドライン

- ✅ ユーザーが「何を」必要とし「なぜ」必要なのかに焦点を当てる
- ❌ 「どのように」実装するかを避ける (技術スタック、API、コード構造なし)
- 👥 ビジネス関係者向けに記述 (開発者向けではない)
