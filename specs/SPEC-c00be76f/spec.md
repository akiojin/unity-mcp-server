# 機能仕様書: スクリーンショット・動画キャプチャ機能

**機能ID**: `SPEC-c00be76f`
**作成日**: 2025-10-17
**ステータス**: 確定
**入力**: Unity Editorからのゲームビュー、シーンビュー、エディタウィンドウ、AI最適化ビューのキャプチャおよび動画録画機能

## 実行フロー (main)
```
1. 入力からキャプチャ要件を解析
   → キャプチャモード（game/scene/window/explorer）の選択
2. キャプチャ対象の特定
   → ゲームビュー: プレイヤー視点
   → シーンビュー: エディタ3Dワークスペース
   → ウィンドウ: 特定のエディタウィンドウ
   → エクスプローラ: AI/LLM分析用最適化ビュー
3. キャプチャ設定の適用
   → 解像度、フレーミング、表示オプション
4. キャプチャ実行
   → スクリーンショット: 画像ファイル生成
   → 動画: Unity Recorderによる録画開始/停止
5. 出力の保存
   → 固定パス: <workspace>/.unity/capture/
6. 戻り値: SUCCESS（キャプチャ完了情報）
```

---

## ⚡ クイックガイドライン
- ✅ 開発者とAIエージェントがUnityシーンを視覚的に理解する必要性に焦点
- ❌ 内部的な画像エンコーディング技術や録画コーデックの詳細は避ける
- 👥 ゲーム開発者・テスター・AIエージェント向けに記述

### セクション要件
- **必須セクション**: すべての機能で完成させる必要がある
- **オプションセクション**: 機能に関連する場合のみ含める

---

## ユーザーシナリオ＆テスト

### 主要ユーザーストーリー
開発者として、デバッグやドキュメント作成のために、Unity Editorの現在の状態を画像または動画として記録したい。AIエージェントとして、シーン内容を理解し分析するために最適化されたビューでスクリーンショットを取得したい。

### 受け入れシナリオ
1. **前提** ゲームビューが表示されている、**実行** ゲームビューのスクリーンショット取得を要求、**結果** `.unity/capture/`に画像が保存される
2. **前提** シーンビューで3Dオブジェクトを編集中、**実行** シーンビューのスクリーンショット取得、**結果** 現在のシーンビューが画像として保存される
3. **前提** コンソールにエラーが表示されている、**実行** コンソールウィンドウのキャプチャ、**結果** コンソールウィンドウの画像が保存される
4. **前提** プレイヤーオブジェクトを分析したい、**実行** エクスプローラモードでプレイヤーを中心にキャプチャ、**結果** 自動フレーミングされたプレイヤーの画像が生成される
5. **前提** ゲームプレイを記録したい、**実行** 動画録画開始、**結果** ゲームビューの録画が開始され、停止後にmp4/webmファイルが保存される
6. **前提** AIが即座に画像分析する、**実行** base64エンコードオプションでキャプチャ、**結果** ファイル保存せずにbase64データが返される

### エッジケース
- キャプチャ中にエディタがフォーカスを失った場合、何が起こるか? → キャプチャは現在の状態で実行される
- 指定したウィンドウが存在しない場合、どう処理するか? → エラーメッセージと利用可能なウィンドウリストを返す
- 録画中にエディタがクラッシュした場合、動画は保存されるか? → 保存されない（Unity Recorderの制限）
- 解像度が極端に大きい（8192x8192）場合、パフォーマンスへの影響は? → メモリ不足エラーの可能性があるため、適切な警告を表示
- エクスプローラモードで対象オブジェクトが見つからない場合、どう処理するか? → エラーメッセージと代替案を提示

## 要件

### 機能要件
- **FR-001**: システムは4種類のキャプチャモード（game/scene/window/explorer）をサポートする必要がある
- **FR-002**: システムはスクリーンショットを`.unity/capture/`ディレクトリに保存する必要がある
- **FR-003**: システムは動画録画にUnity Recorderパッケージを使用する必要がある
- **FR-004**: ユーザーはキャプチャの解像度を指定できる必要がある（1-8192ピクセル）
- **FR-005**: システムはゲームビューキャプチャ時にUIオーバーレイの表示/非表示を制御できる必要がある
- **FR-006**: エクスプローラモードは、AI/LLM向けに最適化された自動フレーミング機能を提供する必要がある
- **FR-007**: システムはGameObject名、タグ、エリア、手動位置によるターゲット指定をサポートする必要がある
- **FR-008**: システムはカメラの視野角、クリッピング面、位置、回転を制御できる必要がある
- **FR-009**: システムは背景色、レイヤー表示、ギズモ表示、コライダー表示を制御できる必要がある
- **FR-010**: システムはbase64エンコードオプションで、ファイル保存せずに画像データを返すことができる必要がある
- **FR-011**: 動画録画は開始、停止、ステータス確認、固定時間録画の4つの操作をサポートする必要がある
- **FR-012**: 動画録画は最大録画時間の指定をサポートする必要がある
- **FR-013**: システムはキャプチャ結果として、パス、解像度、ファイルサイズ、カメラ情報を返す必要がある
- **FR-014**: システムはワークスペースルートを固定し、process.cwd()の変動に依存しない必要がある
- **FR-015**: Unity側はNodeから受け取るworkspaceRootを優先し、未受領時のみ.unity/config.jsonでフォールバックする必要がある

### 非機能要件
- **NFR-001**: スクリーンショット取得は2秒以内に完了する必要がある
- **NFR-002**: 動画録画は30fps以上で安定動作する必要がある
- **NFR-003**: エクスプローラモードの自動フレーミングは1秒以内に計算完了する必要がある
- **NFR-004**: システムは最大8192x8192の解像度をサポートする必要がある
- **NFR-005**: base64エンコードは10MB以下の画像に対して2秒以内に完了する必要がある

### 主要エンティティ
- **ScreenshotCapture**: キャプチャモード、解像度、出力パス、エクスプローラ設定を含むスクリーンショット情報
- **VideoRecording**: 録画ID、キャプチャモード、解像度、FPS、最大録画時間、出力パスを含む動画録画情報
- **ExplorerSettings**: ターゲット設定、カメラ設定、表示設定を含むAI最適化キャプチャの設定情報
- **CaptureResult**: 出力パス、解像度、ファイルサイズ、カメラ情報、オプションでbase64データを含む結果情報

---

## レビュー＆受け入れチェックリスト

### コンテンツ品質
- [x] 実装詳細なし（言語、フレームワーク、API）
- [x] ユーザー価値とビジネスニーズに焦点
- [x] 非技術関係者向けに記述
- [x] すべての必須セクション完成

### 要件完全性
- [x] [要明確化]マーカーが残っていない
- [x] 要件はテスト可能で曖昧さがない
- [x] 成功基準は測定可能
- [x] スコープが明確に境界付けられている
- [x] 依存関係と前提条件が識別されている

---

## 実行ステータス

- [x] ユーザー説明を解析済み
- [x] 主要概念を抽出済み
- [x] 曖昧さをマーク済み
- [x] ユーザーシナリオを定義済み
- [x] 要件を生成済み
- [x] エンティティを識別済み
- [x] レビューチェックリスト合格

---

## 参考実装

### 実装ファイル
- `/mnt/e/unity-mcp-server/mcp-server/src/handlers/screenshot/CaptureScreenshotToolHandler.js`
- `/mnt/e/unity-mcp-server/mcp-server/src/handlers/screenshot/AnalyzeScreenshotToolHandler.js`
- `/mnt/e/unity-mcp-server/mcp-server/src/handlers/video/CaptureVideoStartToolHandler.js`
- `/mnt/e/unity-mcp-server/mcp-server/src/handlers/video/CaptureVideoStopToolHandler.js`
- `/mnt/e/unity-mcp-server/mcp-server/src/handlers/video/CaptureVideoStatusToolHandler.js`
- `/mnt/e/unity-mcp-server/mcp-server/src/handlers/video/CaptureVideoForToolHandler.js`
- `UnityMCPServer/Packages/unity-mcp-server/Editor/Handlers/ScreenshotHandler.cs`
- `UnityMCPServer/Packages/unity-mcp-server/Editor/Handlers/VideoCaptureHandler.cs`

### 技術詳細
- Unity Recorderパッケージ（com.unity.recorder）を使用した動画録画
- ワークスペースルート基準のパス解決（WORKSPACE_ROOT）
- PNG/JPG/WebM/MP4形式のサポート
- Roslyn C# LSPとは独立した動作
