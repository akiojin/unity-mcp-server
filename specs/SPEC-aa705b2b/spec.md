# 機能仕様書: コードインデックスビルドのバックグラウンド実行

**機能ID**: `SPEC-aa705b2b`
**作成日**: 2025-10-29
**ステータス**: 下書き
**入力**: code_index_buildをバックグラウンドジョブ化する機能

## ユーザーシナリオ＆テスト

### ユーザーストーリー1 - 非ブロッキングなインデックスビルド (優先度: P1)

開発者がコードインデックスのビルドを開始すると、即座に制御が戻り、他の作業を並行して進められる。現在は処理完了まで2分以上待機する必要があり、その間他の操作ができない状態となっている。

**この優先度の理由**: これは開発者の生産性に直接影響する最も重要な機能である。長時間のブロッキング操作は開発フローを中断し、開発者体験を著しく損なう。

**独立テスト**: インデックスビルドを開始した後、1秒以内にレスポンスが返ることを確認することで完全にテストできる。これにより、開発者は待機時間なく作業を継続できる価値を提供する。

**受け入れシナリオ**:

1. **前提** 開発者が大規模なプロジェクトでコードインデックスのビルドを必要としている、**実行** インデックスビルドを開始する、**結果** 1秒以内にジョブIDとともにレスポンスが返り、開発者は他の作業を継続できる
2. **前提** インデックスビルドがバックグラウンドで実行中である、**実行** 開発者が他のツールを使用する、**結果** ビルド処理の完了を待つことなく、すべてのツールが正常に動作する

---

### ユーザーストーリー2 - 進捗状況の可視化 (優先度: P1)

開発者がバックグラウンドで実行中のインデックスビルドの進捗状況を確認できる。現在の処理状況（処理済みファイル数、全体のファイル数、処理速度）を把握することで、いつ完了するか予測できる。

**この優先度の理由**: バックグラウンド実行と同様に重要な機能である。進捗が見えないバックグラウンド処理は、開発者に不安を与え、処理が正常に動作しているか確認できない。

**独立テスト**: インデックスビルド開始後に状態確認を行い、進捗情報（処理済み/全体、処理速度）が返されることで完全にテストできる。これにより、開発者は処理の進行状況を把握できる価値を提供する。

**受け入れシナリオ**:

1. **前提** インデックスビルドがバックグラウンドで実行中である、**実行** 開発者が状態確認を行う、**結果** 現在の進捗情報（処理済みファイル数、全体のファイル数、処理速度）が表示される
2. **前提** インデックスビルドが完了している、**実行** 開発者が状態確認を行う、**結果** ビルド完了状態と最終結果（更新されたファイル数、削除されたファイル数）が表示される
3. **前提** インデックスビルドが実行されていない、**実行** 開発者が状態確認を行う、**結果** 実行中のジョブがないことが明示され、既存のインデックス統計情報が表示される

---

### ユーザーストーリー3 - 重複実行の防止 (優先度: P2)

既にインデックスビルドが実行中の場合、新たなビルドを開始しようとすると適切に通知され、既存のジョブIDが返される。これにより、システムリソースを効率的に使用でき、複数のビルドが同時に実行されることによる競合を防ぐ。

**この優先度の理由**: システムリソースの効率的な利用と、複数ビルドによる競合防止に重要だが、基本的なバックグラウンド実行と進捗確認が動作すれば、開発者は手動で重複を避けることができる。

**独立テスト**: ビルド実行中に再度ビルドを開始しようとし、適切なエラーメッセージと既存のジョブIDが返されることで完全にテストできる。これにより、システムリソースの無駄な消費を防ぐ価値を提供する。

**受け入れシナリオ**:

1. **前提** インデックスビルドが既に実行中である、**実行** 開発者が新たなビルドを開始しようとする、**結果** 既にビルドが実行中であることが通知され、既存のジョブIDが返される
2. **前提** 前回のビルドが完了している、**実行** 開発者が新たなビルドを開始する、**結果** 新しいビルドが正常に開始され、新しいジョブIDが返される

---

### エッジケース

- インデックスビルド実行中にシステムが再起動された場合、何が起こるか？
- 自動インデックスビルド（IndexWatcher）と手動ビルドが同時に実行されようとした場合、どのように処理するか？
- インデックスビルド中にエラーが発生した場合、開発者にどのように通知するか？

## 要件

### 機能要件

- **FR-001**: システムはインデックスビルドをバックグラウンドで実行し、即座に制御を開発者に返す必要がある
- **FR-002**: システムはビルド開始時に一意のジョブIDを生成して返す必要がある
- **FR-003**: 開発者はいつでもビルドの進捗状況を確認できる必要がある
- **FR-004**: システムは既に実行中のビルドがある場合、新たなビルドを開始せず、既存のジョブIDを返す必要がある
- **FR-005**: システムは実行中のビルドの進捗情報（処理済みファイル数、全体のファイル数、処理速度）を提供する必要がある
- **FR-006**: システムはビルド完了時に結果情報（更新されたファイル数、削除されたファイル数、総シンボル数）を保持する必要がある
- **FR-007**: システムはビルド中のエラーを記録し、開発者に通知する必要がある
- **FR-008**: システムは自動ビルド（IndexWatcher）と手動ビルドの競合を防ぐ必要がある
- **FR-009**: システムは既存のインデックス状態確認機能との下位互換性を維持する必要がある

### 主要エンティティ

- **ビルドジョブ**: 実行中または完了したインデックスビルドの情報を表す。主要属性は、ジョブID、状態（実行中/完了/失敗）、進捗情報（処理済み/全体/速度）、開始時刻、完了時刻、結果情報
- **インデックス統計**: プロジェクト全体のインデックス状態を表す。主要属性は、総ファイル数、インデックス済みファイル数、カバレッジ率、最終更新時刻、総シンボル数

---

## スコープ外

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- ビルドジョブのキャンセル機能
- 複数のビルドジョブをキューイングする機能
- ビルドジョブの永続化（システム再起動後の復元）
- リアルタイム進捗通知（プッシュ通知）

---

## 技術制約

- 同時に実行できるビルドジョブは1つのみ（リソース競合防止のため）
- ビルドジョブ情報はメモリ内に保持され、システム再起動時に失われる

---

## 前提条件

この機能は以下を前提とします:

- 既存のコードインデックスビルド機能が動作している
- 既存のインデックス状態確認機能（code_index_status）が利用可能である
- 自動インデックスビルド機能（IndexWatcher）が実装されている

---

## 依存関係

この機能は以下に依存します:

- 既存のコードインデックスビルド処理
- 既存のインデックス状態確認ツール（code_index_status）
- 自動インデックス監視機能（IndexWatcher）

---

## 成功基準

以下の成功基準を満たす必要があります:

1. インデックスビルド開始後、1秒以内にジョブIDとともにレスポンスが返る
2. 状態確認時に実行中ジョブの進捗情報（処理済み/全体、処理速度）が正確に表示される
3. 既存のインデックス状態確認機能を使用している開発者は、変更なしで従来どおりの情報を取得できる（下位互換性）
4. ビルドが実行中の場合、新たなビルド開始要求は拒否され、既存のジョブIDが返される
5. 自動ビルドと手動ビルドが同時に実行されることがない
