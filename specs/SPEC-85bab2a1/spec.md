# 機能仕様書: Unity AIエージェントウィンドウ

**機能ID**: `SPEC-85bab2a1`
**作成日**: 2025-10-30
**ステータス**: 下書き
**入力**: ユーザー説明: "Unity Editor上でCodex/Claude CodeおよびカスタムAIツールを実行するチャットウィンドウを提供し、コード生成・テスト実行・シェルコマンドをエディタ内で完結させたい。複数セッション対応が必要。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - エージェントと会話して支援を得る (優先度: P1)

Unity開発者として、Unity Editor内からAIエージェントとのチャットウィンドウを開き、コード生成や実装方針の相談を行いたい。これにより、エディタを離れずに開発アシストを受けられる。

**この優先度の理由**: 会話型の支援が提供されなければ、本機能の価値が成立しないため。

**独立テスト**: メニューからウィンドウを開き、CodexまたはClaude Codeを選択して質問を送信し、応答が表示されることを確認する。

**受け入れシナリオ**:

1. **前提** Unity Editorが起動している、**実行** 「AI Agent Window」を開き、Codexを選択して「プレイヤー移動スクリプトの例を教えて」と送信、**結果** エージェントからテキスト回答が表示される
2. **前提** 開いたウィンドウで会話中、**実行** 過去のメッセージをスクロールして確認、**結果** セッション内の全履歴が読める

---

### ユーザーストーリー2 - エージェントが提案する操作をエディタ内で実行する (優先度: P1)

Unity開発者として、エージェントが推奨するコード生成・テスト実行・シェルコマンドを同じウィンドウから実行し、結果を確認したい。これにより、対話から実行まで途切れない開発サイクルを実現できる。

**この優先度の理由**: エージェント提案を手動で別ツールにコピーする手間をなくし、本機能の価値を最大化するため。

**独立テスト**: エージェントから「`npm test`を実行して」と促され、ウィンドウ内で実行コマンドを承認すると、結果がチャットに記録されることを確認する。

**受け入れシナリオ**:

1. **前提** セッションが開いている、**実行** エージェントに「`git status`を実行して」と依頼し承認する、**結果** シェル実行結果がチャット内にログとして表示される
2. **前提** セッションが開いている、**実行** 「PlayModeテストを走らせて」と依頼し、エージェントが実行して結果サマリを返す、**結果** テストの成功/失敗がチャットに表示される

---

### ユーザーストーリー3 - カスタムAIツールを呼び出す (優先度: P2)

AIチームとして、社内で定義したカスタムAIツールを同じウィンドウから起動し、CodexやClaudeと同様に利用したい。これにより、プロジェクト固有の自動化を統一UIで提供できる。

**この優先度の理由**: 汎用エージェントだけでなく、プロジェクト特化型ツールに拡張できる柔軟性が求められるため。

**独立テスト**: 設定済みのカスタムAIツールが選択リストに現れ、メッセージ送受信とシェル実行要求が成功することを確認する。

**受け入れシナリオ**:

1. **前提** カスタムAIツールが設定済み、**実行** ウィンドウでツールを選択し「ビルドサイズレポートを生成して」と送信、**結果** ツールが応答しレポートテキストを返す
2. **前提** カスタムツールを利用中、**実行** ツールが提案するシェル操作を承認、**結果** 実行ログがチャット内に記録される

---

### ユーザーストーリー4 - 複数セッションを並行運用する (優先度: P2)

Unity開発者として、異なる目的の会話を複数のエージェントセッションで同時に進めたい。これにより、例えばバグ調査とビルド自動化を並行処理できる。

**この優先度の理由**: 単一セッションではチーム開発時の作業が滞るため、複数セッションを許容する必要がある。

**独立テスト**: ウィンドウを2つ開き、それぞれ異なるAIと会話し、互いに干渉しないことを確認する。

**受け入れシナリオ**:

1. **前提** Unity Editorが起動している、**実行** AIウィンドウを2つ開き、片方でCodex、もう片方でカスタムAIを利用、**結果** 各ウィンドウが独立した履歴を保持する
2. **前提** 2つのセッションで同時にシェル実行を依頼、**実行** それぞれの提案を承認、**結果** 実行結果が正しいセッションにのみ表示される

---

### エッジケース

- 外部AIサービスに接続できない場合、セッション開始時にユーザーへ理由と再試行手段を通知する
- エージェントが実行を提案したコマンドが失敗した場合、失敗理由と再実行手段をチャットに追記する
- 同じカスタムAIツールが設定から削除された状態でセッションを再開した場合、利用できない旨を表示して中断する
- 長時間実行する操作（テストやビルド）が進行中にUnityを閉じた場合、ユーザーに進行状況が失われることを警告する
- 大量の出力を返すコマンドを実行した場合でも、チャット表示が途切れずスクロールできる
- 同時に複数セッションを開いた状態で同じAIアカウントを利用する際、レートリミットに達した場合は一時停止と再開条件を通知する

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは Unity Editor のメニューから AI エージェントウィンドウを開く手段を提供しなければならない
- **FR-002**: システムは Codex、Claude Code、登録済みカスタムAIツールをセッション開始時に一覧で選択できるようにしなければならない
- **FR-003**: 各セッションはチャット形式でメッセージ履歴を表示し、最新メッセージを自動的にスクロール表示しなければならない
- **FR-004**: ユーザーが送信したメッセージに対し、選択したエージェントの応答を受信して表示しなければならない
- **FR-005**: エージェントがコード生成やテスト実行、シェル実行などの操作を提案した際、ユーザー確認を経て結果をチャット内に記録しなければならない
- **FR-006**: 実行されたコマンドやテストの結果は開始時間、成功/失敗ステータス、主要ログを含めて提示しなければならない
- **FR-007**: ユーザーは同時に複数のエージェントセッションを開閉でき、各セッションが独立した履歴と状態を保持しなければならない
- **FR-008**: カスタムAIツールは外部設定の更新に応じてウィンドウ上の選択肢へ即座に反映されなければならない
- **FR-009**: セッション内のメッセージと実行ログはコピー可能であり、ユーザーが外部共有できる形式で提供されなければならない
- **FR-010**: エージェントからの提案実行中は進捗状態を可視化し、完了または失敗時に通知しなければならない

### 主要エンティティ

- **エージェントセッション**: 選択されたAIツール、会話履歴、実行ログ、現在の進捗を保持する単位
- **エージェント**: Codex、Claude Code、またはカスタムAIツールを表し、名前・説明・対応アクション種別を属性として持つ
- **アクションリクエスト**: エージェントから提示された実行提案で、タイプ（コード生成／テスト／シェル）、入力内容、結果要約を含む

---

## スコープ外 *(オプション)*

- AIが自動でソースコードへ変更を適用する機能
- 画像や音声を含むマルチモーダル応答の表示
- エージェント会話の永続的なクラウド同期や共有リンク生成

---

## 技術制約 *(該当する場合)*

- AIサービスへのアクセスには外部ネットワーク通信と認証情報が必要であり、オフライン環境では会話機能が利用できない
- 実行結果の表示はテキストベースに限定され、インタラクティブなTTY上書き操作はサポートしない
- Unity Editor のメインスレッド上でUI更新が行われるため、同時実行数が増えると表示反映に遅延が発生する可能性がある

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- `.unity/config.json` にワークスペースルートとプロジェクトルートが設定されている
- Codex、Claude Code、カスタムAIツールに必要なAPIキーや接続設定が有効である
- Unity MCP Server が起動可能な環境であり、必要なバックエンドサービスが稼働している

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- Unity MCP Server のコマンド実行・結果取得インフラ
- エージェントごとの外部AI API または社内AIツールサービス
- 既存の認証・設定管理仕組み（APIキー管理など）

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. ユーザーがウィンドウを開いてから Codex もしくは Claude Code から最初の応答を得るまでの時間が平均5秒以内である
2. エージェント経由で実行した `git status`、`npm test`、PlayModeテストの結果が各セッションのチャットに正しく記録される割合が95%以上である
3. 2つ以上のセッションを同時に開いた状態でも Unity Editor のUI応答が1秒以内に維持される
4. カスタムAIツールを登録後、ウィンドウに表示され利用可能になるまでの時間がリロードを伴わず10秒以内である

**成功基準ガイドライン**:

成功基準は以下の条件を満たす必要があります:

1. **測定可能**: 具体的な指標を含む（時間、パーセンテージ、カウント、レート）
2. **技術に依存しない**: フレームワーク、言語、データベース、ツールに言及しない
3. **ユーザー重視**: システム内部ではなく、ユーザー/ビジネスの視点から結果を説明
4. **検証可能**: 実装の詳細を知らなくてもテスト/検証できる
