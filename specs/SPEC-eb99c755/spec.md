# 機能仕様書: Prebuilt better-sqlite3 配布と初回 npx 体験改善

**機能ID**: `SPEC-eb99c755`
**作成日**: 2025-11-19
**ステータス**: 下書き
**入力**: ユーザー説明: "初回 npx で better-sqlite3 のビルド待ちをなくし、npm パッケージ内に prebuilt を同梱してユーザー操作なしで即応答にする。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 初回起動でも即応答 (優先度: P1)

Unity MCP Server を初めてインストールするユーザーとして、`npx @akiojin/unity-mcp-server@latest` を実行した瞬間にサーバーが起動し、タイムアウトや手作業なく Unity との接続準備ができてほしい。

**この優先度の理由**: 初回が 60–90 秒待ちになると MCP クライアントが 30 秒でタイムアウトし機能を体験できないため、最もクリティカルな改善点。

**独立テスト**: クリーン環境で `npx @akiojin/unity-mcp-server@latest --help` を実行し、30 秒以内に完了することを確認すれば達成可。

**受け入れシナリオ**:

1. **前提** npm キャッシュをクリアした状態、**実行** `npx -y @akiojin/unity-mcp-server@latest --version`、**結果** 30 秒以内にバージョン文字列が出力される
2. **前提** MCP クライアント (Claude Code) がデフォルト 30 秒タイムアウト、**実行** サーバーを起動、**結果** タイムアウトせず接続完了ログが表示される

---

### ユーザーストーリー2 - ネイティブ性能を即利用 (優先度: P2)

ハイパフォーマンスを期待するユーザーとして、初回から better-sqlite3 のネイティブドライバが利用可能で、検索やコードインデックス操作が即座に高速で動いてほしい。

**この優先度の理由**: WASM フォールバックだけでも動くが、大規模プロジェクトではネイティブ性能が重要。初回から利用できれば移行や評価がスムーズになる。

**独立テスト**: インストール直後に `node -e "require('better-sqlite3')"` が成功し、コードインデックス API のレスポンスが従来と同等であることを確認。

**受け入れシナリオ**:

1. **前提** クリーン環境で `npm ci --workspace=mcp-server`、**実行** `node -e "require('better-sqlite3')"`、**結果** エラーなくロードできる
2. **前提** Unity プロジェクトで code_index_build を実行、**実行** API 応答時間を測定、**結果** 以前と同等(±10%)の速度で完了する

---

### ユーザーストーリー3 - エッジ環境でも安全に fallback (優先度: P3)

サポート対象外の OS/CPU を使うユーザーとして、prebuilt がなくても自動的に WASM フォールバックで動作し、必要なら明示的にネイティブビルドを強制できるようにしてほしい。

**この優先度の理由**: 少数派だが重要。サポート外環境で起動不能になるとサポートコストが増大するため。

**独立テスト**: 対応バイナリが無い環境をシミュレートし、WASM フォールバックで code_index_status が成功することを確認。

**受け入れシナリオ**:

1. **前提** `UNITY_MCP_SKIP_NATIVE_BUILD=1` を設定、**実行** `npm ci --workspace=mcp-server`、**結果** ネイティブビルドなしでインストールが完了し `sql.js` モードで code_index_status が成功する
2. **前提** 同環境で `UNITY_MCP_FORCE_NATIVE=1` を設定、**実行** `npm ci`、**結果** ソースビルドが試行され、失敗時もフォールバックする旨のログが出る

---

### エッジケース

- prebuilt が壊れている場合にどのように検出し、fallback するか?
- npm パッケージサイズが増大した際、ネットワーク帯域の制限にどう対応するか?
- 特定の Node バージョン (例: 18.x) だけ prebuilt が存在しない場合、ユーザーにどう通知するか?

## 要件 *(必須)*

### 機能要件

- **FR-001**: npm パッケージに linux/darwin/win32 × x64/arm64 × Node18/20/22 向け better-sqlite3 バイナリを同梱する。
- **FR-002**: インストール時は同梱バイナリを優先して展開し、30 秒以内に完了すること。
- **FR-003**: 未対応プラットフォームでは即座に WASM フォールバックに切り替わること。
- **FR-004**: 環境変数でネイティブビルド強制 (`UNITY_MCP_FORCE_NATIVE=1`) またはスキップ (`UNITY_MCP_SKIP_NATIVE_BUILD=1`) を制御できること。
- **FR-005**: README（英/日）に初回体験と環境変数の説明を記載し、手動ウォームを推奨しないこと。

### 主要エンティティ

- **Prebuiltバイナリ**: better-sqlite3 のプラットフォーム別ビルド成果物。Node バージョン・OS・アーキテクチャの組み合わせで管理。
- **インストーラスクリプト**: postinstall で実行される `ensure-better-sqlite3.mjs`。バイナリ検知とフォールバックを担当。

## スコープ外 *(オプション)*

- OpenUPM や Unity パッケージ側での同様の最適化
- better-sqlite3 以外のネイティブ依存（例: csharp-lsp）の最適化

## 技術制約 *(該当する場合)*

- npm publish サイズ増加を 50MB 未満に抑える
- prebuildify または同等ツールで再現可能なビルドパイプラインを維持する

## 前提条件 *(該当する場合)*

- GitHub Actions で全プラットフォームの prebuild を生成できる CI リソースがある
- better-sqlite3 のライセンス（MIT）に基づきバイナリ再配布が許可されている

## 依存関係 *(該当する場合)*

- SPEC-1ac96646（リリース自動化）
- SPEC-bf408776（semantic-release / npm publish の整合性）

## 成功基準 *(必須)*

1. クリーン環境での `npx @akiojin/unity-mcp-server@latest --help` が 30 秒以内に完了する再現テストが 100% 通過する。
2. better-sqlite3 を `require` したときにネイティブドライバがロードされる成功率が 95%以上（主要 OS/CPU/Node の組み合わせ）。
3. 対応外プラットフォームでも WASM フォールバックで code_index_status が成功し、サポート問い合わせ件数が前バージョン比で 50% 以上減少する（ローンチ後 2 週間）。
