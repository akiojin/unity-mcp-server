# 機能仕様書: Unity接続の安定化（接続先ホスト正規化 + Heartbeat）

**機能ID**: `SPEC-4c3e2f91`  
**作成日**: 2025-12-12  
**ステータス**: 下書き  
**入力**: issue #224（0.0.0.0接続の再接続ループ）, issue #222（Unity側起動/再起動時の不安定）, 既存 transport 実装

## 背景

- `.unity/config.json` の `unity.mcpHost` / 旧キーの誤設定で `0.0.0.0` や `*` のような「待受専用値」が接続先に渡り、Node 側が接続失敗→指数バックオフ再接続を繰り返す事故が発生している。  
- Unity Editor はコンパイル/ドメインリロード/長時間アイドルでソケットが半死状態になることがあり、Node 側が気付かずコマンドがタイムアウトし続けることがある。

## 目的

1. **誤設定の自動回避**により、環境差分や旧キー利用でも安全に接続できるようにする。  
2. **Heartbeat による死活監視**で、半死に接続を早期に検出し自動再接続できるようにする。

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - bind用ホスト誤指定でも接続が成立してほしい (優先度: P0)
Docker/CI などで `unity.unityHost=0.0.0.0` を使う設定のまま `mcpHost` 未設定・旧キーを流用すると、接続先が `0.0.0.0` になり接続不能になる。Node 側が自動で補正し、安全に接続してほしい。

**独立テスト**: `mcpHost` が `0.0.0.0`/`*`/`::` のとき、接続先が `127.0.0.1` に正規化され警告が出れば価値成立。

**受け入れシナリオ**:
1. **前提** configで `unity.mcpHost="0.0.0.0"`、**実行** `connect()`、**結果** 実際の接続先は `127.0.0.1` になり warning ログが出る。
2. **前提** configで `unity.mcpHost="*"`、**実行** `connect()`、**結果** `127.0.0.1` に正規化される。
3. **前提** configで `unity.mcpHost` 未設定かつ `unity.unityHost="0.0.0.0"`、**実行** `connect()`、**結果** `127.0.0.1` を使用する。

---

### ユーザーストーリー2 - アイドル/半死に接続を自動復旧してほしい (優先度: P0)
Unity がビジー/アイドルの境界でソケットが無応答になっても、ユーザーは明示操作なしで復旧してほしい。

**独立テスト**: 接続後に Heartbeat が一定回数失敗したら Node が `disconnected` を発火し再接続をスケジュールできれば価値成立。

**受け入れシナリオ**:
1. **前提** 接続中でコマンド送信が無い、**実行** Heartbeat を待機、**結果** 定期的に `ping` が送信され、`pong` を受信すれば接続維持。
2. **前提** 接続中で `pong` が返らない状態、**実行** Heartbeat を待機、**結果** 規定回数の失敗後にソケットを閉じ再接続が走る。

## 要件 *(必須)*

### 機能要件
- **FR-001**: `unity.mcpHost` 解決時に、接続先として不正な値（`0.0.0.0` / `*` / `::` / 空文字）を検出した場合は **`127.0.0.1` に正規化**し warning を出す。
- **FR-002**: 接続中かつアイドル時に Heartbeat を送信し、`pong` 応答の有無で死活監視を行う。
- **FR-003**: Heartbeat が `heartbeatMissThreshold` 回連続で失敗した場合、Node 側はソケットを閉じ **自動再接続**へ移行する。
- **FR-004**: Heartbeat は Unity のメインスレッドを塞がないため、**フレーム付き文字列 `"ping"`** を利用する。

### 非機能要件
- **NFR-001**: Heartbeat により通常コマンドのレイテンシが悪化しない（同時 in-flight は 1 を維持）。
- **NFR-002**: Heartbeat のネットワーク負荷は最小化（アイドル時のみ送信、短い payload）。

### 設定
- `unity.heartbeatIntervalMs` (default: `10000`)  
- `unity.heartbeatTimeoutMs` (default: `2000`)  
- `unity.heartbeatMissThreshold` (default: `3`)

## スコープ外
- セッション/ハンドシェイク導入やレスポンス整合性の大規模変更（P1以降）。
- 複数Unityインスタンスの自動フェイルオーバー。

## 技術制約
- Unity側は既存の framed `"ping"` → `"pong"` 経路を利用するため、新規API追加は不要。
